import{a as L,r as i,j as a,A as R,S as g,M as S,af as D,n as l,Z as C}from"./index-grL27em3.js";import{C as F}from"./Collapsible-0ER5Bbk1.js";import{V as O}from"./ViewCvButton-Cqus7HoZ.js";import{c as b}from"./pii-BcFV6mqh.js";import"./files-CjotXup9.js";function _(r){if(!r)return"";const d=r instanceof Date?r:new Date(r);return Number.isNaN(d.getTime())?String(r):d.toLocaleString()}function B(){const{token:r,role:d,legacyRole:x,canPortal:j,canAction:N}=L();function v(e,t){const s=typeof j=="function"?j(e):null;if(s===!0||s===!1)return s;const n=String(x||d||"").toUpperCase();return Array.isArray(t)?t.includes(n):!1}function m(e,t){const s=typeof N=="function"?N(e):null;if(s===!0||s===!1)return s;const n=String(x||d||"").toUpperCase();return Array.isArray(t)?t.includes(n):!1}const f=v("PORTAL_FAIL_CANDIDATES",["HR","ADMIN"]),[p,I]=i.useState(!1),[c,y]=i.useState([]),[o,u]=i.useState("");async function h(){if(f&&m("FAIL_CANDIDATES_LIST",["HR","ADMIN"])){I(!0);try{const e=await D(r,{stageName:"ONLINE_TEST",includeResolved:!1});y(e.items??[])}catch(e){l.error((e==null?void 0:e.message)||"Failed to load")}finally{I(!1)}}}i.useEffect(()=>{h()},[f]);const T=i.useMemo(()=>c.length,[c]);async function A(e){if(!m("TEST_FAIL_DECIDE",["HR","ADMIN"])){l.error("Not allowed");return}const t=`${e.candidateId}:CONTINUE`;u(t);try{await C(r,{requirementId:e.requirementId,candidateId:e.candidateId,testType:"ONLINE_TEST",decision:"CONTINUE",remark:"",stageTag:"Online Test",meta:{score:e.score??null}}),l.success("Continued"),y(s=>s.filter(n=>n.candidateId!==e.candidateId))}catch(s){l.error((s==null?void 0:s.message)||"Failed")}finally{u("")}}async function E(e){if(!m("TEST_FAIL_DECIDE",["HR","ADMIN"])){l.error("Not allowed");return}const t=window.prompt("Reject remark (required):","");if(!t)return;const s=`${e.candidateId}:REJECT`;u(s);try{await C(r,{requirementId:e.requirementId,candidateId:e.candidateId,testType:"ONLINE_TEST",decision:"REJECT",remark:t,stageTag:"Online Test",meta:{score:e.score??null}}),l.success("Rejected"),y(n=>n.filter(w=>w.candidateId!==e.candidateId))}catch(n){l.error((n==null?void 0:n.message)||"Failed")}finally{u("")}}return a.jsxs(R,{children:[f?null:a.jsxs("div",{className:"card",style:{padding:12,marginBottom:12},children:[a.jsx("div",{style:{fontWeight:700},children:"Not allowed"}),a.jsx("div",{className:"small",style:{color:"var(--gray-600)"},children:"You don’t have access to Fail Candidates."})]}),a.jsxs("div",{style:{marginBottom:"20px"},children:[a.jsx("h1",{className:"page-title",children:"Fail Candidates"}),a.jsx("p",{className:"page-subtitle",children:"Candidates who failed Online Test"})]}),a.jsx("div",{className:"card",style:{marginBottom:16},children:a.jsxs("div",{className:"row",style:{gap:12,alignItems:"flex-end",flexWrap:"wrap"},children:[a.jsx("button",{className:"button",type:"button",onClick:h,disabled:p,children:p?a.jsxs(a.Fragment,{children:[a.jsx(g,{size:14})," Refreshing..."]}):"Refresh"}),a.jsx("div",{style:{marginLeft:"auto"},children:a.jsxs("span",{className:"badge",children:[T," candidates"]})})]})}),p?a.jsx(S,{text:"Loading..."}):a.jsx(F,{title:"Online Test FAIL",subtitle:"Continue or Reject (audited)",badge:T,variant:"card",defaultOpen:!0,children:c.length===0?a.jsxs("div",{className:"empty-state",children:[a.jsx("div",{className:"empty-state-icon",children:"✓"}),a.jsx("div",{className:"empty-state-text",children:"No failed candidates"})]}):a.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:10},children:c.map(e=>{const t=`${e.candidateId}:CONTINUE`,s=`${e.candidateId}:REJECT`;return a.jsx("div",{className:"card",style:{background:"#fff",border:"1px solid var(--gray-200)"},children:a.jsxs("div",{className:"row",style:{justifyContent:"space-between",gap:12,flexWrap:"wrap",alignItems:"center"},children:[a.jsxs("div",{children:[a.jsxs("div",{style:{fontWeight:700,fontSize:"15px"},children:[b(e)||e.candidateId,b(e)&&e.candidateId?a.jsxs("span",{className:"small",style:{fontWeight:400,marginLeft:8,color:"var(--gray-500)"},children:["(",e.candidateId,")"]}):null]}),a.jsxs("div",{className:"small",style:{color:"var(--gray-500)",marginTop:2},children:[e.jobTitle?`${e.jobTitle} · `:"",e.jobRole||"-"]}),a.jsxs("div",{style:{marginTop:8,display:"flex",gap:8,flexWrap:"wrap"},children:[a.jsxs("span",{className:"badge",style:{background:"#ef4444",color:"#fff"},children:["FAIL",e.score!=null&&e.score!==""?` (${e.score})`:""]}),e.failedAt?a.jsxs("span",{className:"badge",children:["Failed: ",_(e.failedAt)]}):null,e.reason?a.jsx("span",{className:"badge",children:e.reason}):null]})]}),a.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[a.jsx(O,{cvFileId:e.cvFileId,token:r}),a.jsxs("button",{className:"button",type:"button",onClick:()=>A(e),disabled:!!o,children:[o===t?a.jsx(g,{size:14}):null,"Continue"]}),a.jsxs("button",{className:"button danger",type:"button",onClick:()=>E(e),disabled:!!o,children:[o===s?a.jsx(g,{size:14}):null,"Reject"]})]})]})},e.id||e.candidateId)})})})]})}export{B as FailCandidatesPage};
