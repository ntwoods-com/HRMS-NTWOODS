import{a as Y,r as d,j as s,h as Q,S as L,_ as X,af as Z,n as u,ag as q,a3 as ee}from"./index-DOrSdxar.js";import{C as G}from"./Collapsible-DWCF1e2K.js";import{S as M}from"./SlaCountdown-Dbjbgs8L.js";import{S as se,C as ae,B as ne,a as re}from"./BulkActionBar-VteGmzV5.js";import{c as b}from"./pii-BcFV6mqh.js";import"./useNowTick-jLJk1rJb.js";function V(c){const l=String(c||"").toUpperCase();return l==="APPROVED"?{background:"#22c55e",color:"#fff"}:l==="REJECTED"?{background:"#ef4444",color:"#fff"}:l==="REVIEW_PENDING"?{background:"#f59e0b",color:"#fff"}:l==="PENDING"?{background:"var(--gray-200)",color:"var(--gray-800)"}:{background:"var(--gray-100)",color:"var(--gray-700)"}}function $(c){const l=String(c||"").toUpperCase();return l==="APPROVED"?"PASS":l==="REJECTED"?"FAIL":l==="REVIEW_PENDING"?"REVIEW PENDING":l==="NOT_SELECTED"?"NOT SELECTED":l||"-"}function ue(){var F;const{token:c,role:l,legacyRole:P,canPortal:k,canAction:A}=Y();function B(e,r){const a=typeof k=="function"?k(e):null;if(a===!0||a===!1)return a;const n=String(P||l||"").toUpperCase();return Array.isArray(r)?r.includes(n):!1}function x(e,r){const a=typeof A=="function"?A(e):null;if(a===!0||a===!1)return a;const n=String(P||l||"").toUpperCase();return Array.isArray(r)?r.includes(n):!1}const y=B("PORTAL_HR_FINAL",["HR","ADMIN"]),[I,C]=d.useState(!1),[h,T]=d.useState([]),[S,N]=d.useState("PASSED"),[O,R]=d.useState(""),[p,D]=d.useState({}),[E,_]=d.useState({open:!1,candidate:null}),[m,f]=d.useState({}),[g,j]=d.useState({open:!1,title:"",current:0,total:0,errors:[]});async function H(e){if(!y||!x("CANDIDATE_TESTS_GET",["HR","ADMIN"]))return;if(!Array.isArray(e)||e.length===0){D({});return}const r=e.map(i=>ee(c,{requirementId:i.requirementId,candidateId:i.candidateId}).then(t=>[i.candidateId,t]).catch(()=>null)),a=await Promise.all(r),n={};for(const i of a)i&&(n[i[0]]=i[1]);D(n)}async function w(){if(y&&x("FINAL_INTERVIEW_LIST",["HR","ADMIN"])){C(!0);try{const r=(await Z(c)).items??[];T(r),await H(r)}catch(e){u.error((e==null?void 0:e.message)||"Failed to load")}finally{C(!1)}}}d.useEffect(()=>{w()},[y]);const o=d.useMemo(()=>h.filter(e=>String(e.status||"").toUpperCase()!=="FINAL_OWNER_PENDING"),[h]),v=d.useMemo(()=>h.filter(e=>String(e.status||"").toUpperCase()==="FINAL_OWNER_PENDING"),[h]);async function K(e){if(!x("FINAL_SEND_OWNER",["HR","ADMIN"])){u.error("Not allowed");return}const r=`${e.requirementId}:${e.candidateId}:SEND_OWNER`;R(r);try{await q(c,{requirementId:e.requirementId,candidateId:e.candidateId}),u.success("Sent to Owner"),T(a=>a.map(n=>n.candidateId===e.candidateId?{...n,status:"FINAL_OWNER_PENDING"}:n)),N("PENDING_OWNER")}catch(a){u.error((a==null?void 0:a.message)||"Failed")}finally{R("")}}function W(e){if(!(e!=null&&e.cvFileId)){u.error("CV not available");return}_({open:!0,candidate:e})}function U(e,r){f(a=>{const n={...a};return r?n[e]=!0:delete n[e],n})}function z(e){if(e){const r={};o.forEach(a=>{r[a.candidateId]=!0}),f(r)}else f({})}async function J(){const e=Object.keys(m);if(e.length===0){u.error("Select candidates first");return}j({open:!0,title:"Sending to Owner...",current:0,total:e.length,errors:[]});let r=[];for(let a=0;a<e.length;a++){const n=e[a],i=o.find(t=>t.candidateId===n);if(i){j(t=>({...t,current:a+1}));try{await q(c,{requirementId:i.requirementId,candidateId:n})}catch(t){r.push({id:n,message:(t==null?void 0:t.message)||"Failed"})}}}j(a=>({...a,errors:r})),u.success(`Sent to Owner: ${e.length-r.length}/${e.length}`),f({}),await w(),N("PENDING_OWNER")}return s.jsxs(Q,{children:[y?null:s.jsxs("div",{className:"card",style:{padding:12,marginBottom:12},children:[s.jsx("div",{style:{fontWeight:700},children:"Not allowed"}),s.jsx("div",{className:"small",style:{color:"var(--gray-600)"},children:"You donâ€™t have access to Final Interview portal."})]}),s.jsxs("div",{style:{marginBottom:"20px"},children:[s.jsx("h1",{className:"page-title",children:"Final Interview"}),s.jsx("p",{className:"page-subtitle",children:"Candidates eligible for final interview"})]}),s.jsxs("div",{className:"card",style:{marginBottom:"16px"},children:[s.jsxs("div",{className:"row",style:{gap:12,alignItems:"flex-end",flexWrap:"wrap"},children:[s.jsxs("button",{className:"button",onClick:w,disabled:I,style:{display:"flex",alignItems:"center",gap:6},children:[I?s.jsx(L,{size:14}):null,"Refresh"]}),s.jsx("div",{style:{marginLeft:"auto"},children:s.jsxs("span",{className:"badge",children:[h.length," candidates"]})})]}),s.jsx("div",{style:{height:12}}),s.jsxs("div",{className:"tabs",children:[s.jsxs("button",{type:"button",className:["tab",S==="PASSED"?"active":""].join(" "),onClick:()=>N("PASSED"),children:["Passed (",o.length,")"]}),s.jsxs("button",{type:"button",className:["tab",S==="PENDING_OWNER"?"active":""].join(" "),onClick:()=>N("PENDING_OWNER"),children:["Pending Owner (",v.length,")"]})]})]}),I?s.jsx(X,{text:"Loading candidates..."}):s.jsx(s.Fragment,{children:S==="PASSED"?s.jsx(G,{title:"Ready for Final Interview",subtitle:"Send these candidates to Owner for final interview",badge:o.length,variant:"card",defaultOpen:!0,children:o.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("div",{className:"empty-state-icon",children:"âœ…"}),s.jsx("div",{className:"empty-state-text",children:"No candidates ready"})]}):s.jsxs(s.Fragment,{children:[s.jsx("div",{style:{marginBottom:12,padding:"8px 12px",background:"var(--gray-50)",borderRadius:8},children:s.jsx(se,{checked:Object.keys(m).length===o.length,indeterminate:Object.keys(m).length>0&&Object.keys(m).length<o.length,onChange:z,label:`Select All (${o.length})`})}),s.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:10},children:o.map(e=>{var i;const r=`${e.requirementId}:${e.candidateId}:SEND_OWNER`,a=((i=p==null?void 0:p[e.candidateId])==null?void 0:i.requiredTests)??[],n=!!m[e.candidateId];return s.jsx("div",{className:"card",style:{background:n?"rgba(59, 130, 246, 0.05)":"#fff",border:n?"2px solid var(--primary)":"1px solid var(--gray-200)",transition:"all 0.2s ease"},children:s.jsxs("div",{className:"row",style:{justifyContent:"space-between",gap:12,flexWrap:"wrap",alignItems:"flex-start"},children:[s.jsxs("div",{style:{display:"flex",gap:12,alignItems:"flex-start",flex:1},children:[s.jsx("input",{type:"checkbox",checked:n,onChange:t=>U(e.candidateId,t.target.checked),style:{width:18,height:18,marginTop:4,cursor:"pointer"}}),s.jsxs("div",{style:{flex:1},children:[s.jsxs("div",{style:{fontWeight:700,fontSize:"15px"},children:[b(e)||e.candidateId,b(e)&&e.candidateId?s.jsxs("span",{className:"small",style:{fontWeight:400,marginLeft:8,color:"var(--gray-500)"},children:["(",e.candidateId,")"]}):null]}),s.jsxs("div",{className:"small",style:{color:"var(--gray-500)",marginTop:2},children:[e.jobTitle?`${e.jobTitle} Â· `:"",e.jobRole||"-"]}),s.jsxs("div",{style:{marginTop:8,display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(160px, 1fr))",gap:6,padding:"8px 12px",background:"var(--gray-50)",borderRadius:8},children:[e.phone&&s.jsxs("div",{className:"small",children:["ðŸ“ž ",s.jsx("strong",{children:"Phone:"})," ",e.phone]}),e.email&&s.jsxs("div",{className:"small",children:["âœ‰ï¸ ",s.jsx("strong",{children:"Email:"})," ",e.email]}),e.experience&&s.jsxs("div",{className:"small",children:["ðŸ’¼ ",s.jsx("strong",{children:"Exp:"})," ",e.experience]}),e.currentSalary&&s.jsxs("div",{className:"small",children:["ðŸ’° ",s.jsx("strong",{children:"Current:"})," ",e.currentSalary]}),e.expectedSalary&&s.jsxs("div",{className:"small",children:["ðŸ’µ ",s.jsx("strong",{children:"Expected:"})," ",e.expectedSalary]}),e.noticePeriod&&s.jsxs("div",{className:"small",children:["â±ï¸ ",s.jsx("strong",{children:"Notice:"})," ",e.noticePeriod]}),e.source&&s.jsxs("div",{className:"small",children:["ðŸ“Œ ",s.jsx("strong",{children:"Source:"})," ",e.source]})]}),s.jsx(M,{sla:e.sla}),s.jsxs("div",{style:{marginTop:6,display:"flex",gap:8,flexWrap:"wrap"},children:[s.jsxs("span",{className:"badge",style:{background:"#22c55e",color:"#fff"},children:["In-person: ",e.inPersonMarks,"/10"]}),Array.isArray(a)&&a.length?a.map(t=>s.jsxs("span",{className:"badge",style:V(t.status),children:[t.label||t.testKey,": ",$(t.status),t.marksNumber!=null?` (${t.marksNumber}/10)`:""]},t.testKey)):s.jsx("span",{className:"badge",children:"No required tests"})]})]})]}),s.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[s.jsx("button",{className:"button",type:"button",onClick:()=>W(e),children:"ðŸ“„ View CV"}),s.jsxs("button",{className:"button primary",type:"button",onClick:()=>K(e),disabled:!!O||!x("FINAL_SEND_OWNER",["HR","ADMIN"]),children:[O===r?s.jsx(L,{size:14}):null,"Send to Owner"]})]})]})},e.candidateId)})})]})}):s.jsx(G,{title:"Pending Final Interview (Owner)",subtitle:"Waiting for Owner's final decision",badge:v.length,variant:"card",defaultOpen:!0,children:v.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("div",{className:"empty-state-icon",children:"â³"}),s.jsx("div",{className:"empty-state-text",children:"No candidates pending"})]}):s.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:10},children:v.map(e=>{var a;const r=((a=p==null?void 0:p[e.candidateId])==null?void 0:a.requiredTests)??[];return s.jsxs("div",{className:"card",style:{background:"#fff",border:"1px solid var(--gray-200)"},children:[s.jsxs("div",{style:{fontWeight:700,fontSize:"15px"},children:[b(e)||e.candidateId,b(e)&&e.candidateId?s.jsxs("span",{className:"small",style:{fontWeight:400,marginLeft:8,color:"var(--gray-500)"},children:["(",e.candidateId,")"]}):null]}),s.jsxs("div",{className:"small",style:{color:"var(--gray-500)",marginTop:2},children:[e.jobTitle?`${e.jobTitle} Â· `:"",e.jobRole||"-"]}),s.jsxs("div",{style:{marginTop:8,display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(160px, 1fr))",gap:6,padding:"8px 12px",background:"var(--gray-50)",borderRadius:8},children:[e.phone&&s.jsxs("div",{className:"small",children:["ðŸ“ž ",s.jsx("strong",{children:"Phone:"})," ",e.phone]}),e.email&&s.jsxs("div",{className:"small",children:["âœ‰ï¸ ",s.jsx("strong",{children:"Email:"})," ",e.email]}),e.experience&&s.jsxs("div",{className:"small",children:["ðŸ’¼ ",s.jsx("strong",{children:"Exp:"})," ",e.experience]}),e.currentSalary&&s.jsxs("div",{className:"small",children:["ðŸ’° ",s.jsx("strong",{children:"Current:"})," ",e.currentSalary]}),e.expectedSalary&&s.jsxs("div",{className:"small",children:["ðŸ’µ ",s.jsx("strong",{children:"Expected:"})," ",e.expectedSalary]}),e.source&&s.jsxs("div",{className:"small",children:["ðŸ“Œ ",s.jsx("strong",{children:"Source:"})," ",e.source]})]}),s.jsx(M,{sla:e.sla}),s.jsx("div",{style:{marginTop:10},children:s.jsx("button",{className:"button",type:"button",onClick:()=>W(e),children:"ðŸ“„ View CV"})}),s.jsxs("div",{style:{marginTop:6,display:"flex",gap:8,flexWrap:"wrap"},children:[s.jsxs("span",{className:"badge",style:{background:"#22c55e",color:"#fff"},children:["In-person: ",e.inPersonMarks,"/10"]}),Array.isArray(r)&&r.length?r.map(n=>s.jsxs("span",{className:"badge",style:V(n.status),children:[n.label||n.testKey,": ",$(n.status),n.marksNumber!=null?` (${n.marksNumber}/10)`:""]},n.testKey)):s.jsx("span",{className:"badge",children:"No required tests"})]}),s.jsx("div",{style:{marginTop:12,padding:"10px 12px",background:"#fef3c7",borderRadius:"var(--radius)",fontSize:"13px"},children:"â³ Pending Final Interview (Owner) â€” Locked"})]},e.candidateId)})})})}),s.jsx(ae,{open:E.open,onClose:()=>_({open:!1,candidate:null}),cvFileId:(F=E.candidate)==null?void 0:F.cvFileId,token:c,candidate:E.candidate}),s.jsx(ne,{open:g.open,title:g.title,current:g.current,total:g.total,errors:g.errors,onClose:()=>j({open:!1,title:"",current:0,total:0,errors:[]})}),s.jsx(re,{selectedCount:Object.keys(m).length,onClearSelection:()=>f({}),loading:g.open,actions:[{label:"Bulk Send to Owner",onClick:J,variant:"primary",icon:"ðŸ“¤",disabled:!x("FINAL_SEND_OWNER",["HR","ADMIN"])}]})]})}export{ue as FinalInterviewPage};
