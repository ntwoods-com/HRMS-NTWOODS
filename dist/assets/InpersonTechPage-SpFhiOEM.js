import{a as oe,r as d,j as s,A as ce,Z as J,n as u,V as ue,S as F,M as me,_ as pe,$ as ge,a0 as fe,a1 as ye,R as xe}from"./index-grL27em3.js";import{C as L}from"./Collapsible-0ER5Bbk1.js";import{V as O}from"./ViewCvButton-Cqus7HoZ.js";import{c as y}from"./pii-BcFV6mqh.js";import{S as W}from"./SlaCountdown-DTF7N97H.js";import"./files-CjotXup9.js";import"./useNowTick-_9wyDYsU.js";function he(l){if(!l)return"";const x=l instanceof Date?l:new Date(l);return Number.isNaN(x.getTime())?String(l):x.toLocaleString()}function Re(){const{token:l,role:x,legacyRole:K,canPortal:$,canAction:H}=oe();function Q(e,a){const r=typeof $=="function"?$(e):null;if(r===!0||r===!1)return r;const t=String(K||x||"").toUpperCase();return Array.isArray(a)?a.includes(t):!1}function g(e,a){const r=typeof H=="function"?H(e):null;if(r===!0||r===!1)return r;const t=String(K||x||"").toUpperCase();return Array.isArray(a)?a.includes(t):!1}const h=Q("PORTAL_HR_INPERSON",["HR","ADMIN"]),[A,B]=d.useState(!1),[p,Y]=d.useState("ALL"),[I,U]=d.useState([]),[E,V]=d.useState({}),[G,z]=d.useState([]),[M,C]=d.useState({}),[w,D]=d.useState({}),[f,v]=d.useState(""),[o,N]=d.useState(null),[q,j]=d.useState("");function T(e,a){try{const r=JSON.parse(String((e==null?void 0:e.testDecisionsJson)||"{}")),t=r==null?void 0:r[a];return String((t==null?void 0:t.decision)||"").toUpperCase()==="CONTINUE"}catch{return!1}}const Z=d.useMemo(()=>{const e=Array.from(new Set(I.map(a=>a.jobRole).filter(Boolean)));return e.sort((a,r)=>String(a).localeCompare(String(r))),["ALL",...e]},[I]);async function X(){if(h&&g("TEST_MASTER_GET",["HR","ADMIN"]))try{const e=await pe(l,{activeOnly:!0});z(e.items??[])}catch{z([])}}async function ee(e){if(!h||!g("CANDIDATE_TESTS_GET",["HR","ADMIN"]))return;if(!Array.isArray(e)||e.length===0){C({});return}const a={};for(const r of e)try{const t=await xe(l,{requirementId:r.requirementId,candidateId:r.candidateId});a[r.candidateId]=t}catch{}C(a),D(r=>{var n;const t={...r};for(const c of e){if(t[c.candidateId])continue;const i=((n=a==null?void 0:a[c.candidateId])==null?void 0:n.requiredTests)??[],m=Array.isArray(i)?i.map(le=>le.testKey).filter(Boolean):[];t[c.candidateId]=m}return t})}async function S(e){if(h&&g("INPERSON_PIPELINE_LIST",["HR","ADMIN"])){B(!0);try{const a=await ge(l,{jobRole:e&&e!=="ALL"?e:""});U(a.items??[]),ee(a.items??[]);const r={};for(const t of a.items??[])r[t.candidateId]=t.inPersonMarks??"";V(r)}catch(a){u.error((a==null?void 0:a.message)||"Failed to load")}finally{B(!1)}}}d.useEffect(()=>{X(),S(p)},[p,h]);const b=d.useMemo(()=>p==="ALL"?I:I.filter(e=>e.jobRole===p),[I,p]),P=d.useMemo(()=>b.filter(e=>e.inPersonMarks===""||e.inPersonMarks==null),[b]),R=d.useMemo(()=>b.filter(e=>e.inPersonMarks!==""&&e.inPersonMarks!=null),[b]),k=d.useMemo(()=>R.filter(e=>{const a=Number(e.inPersonMarks);return!Number.isFinite(a)||a>=6?!1:!T(e,"INPERSON_MARKS")}),[R]),_=d.useMemo(()=>R.filter(e=>{const a=Number(e.inPersonMarks);return Number.isFinite(a)?a>=6?!0:T(e,"INPERSON_MARKS"):!1}),[R]);async function se(e){if(!g("INPERSON_MARKS_SAVE",["HR","ADMIN"])){u.error("Not allowed");return}const a=E[e.candidateId],r=Number(a);if(!Number.isFinite(r)){u.error("Enter marks (0-10)");return}const t=`${e.candidateId}:MARKS`;v(t);try{const n=await fe(l,{requirementId:e.requirementId,candidateId:e.candidateId,marks:r});if(n.decisionRequired&&String(n.passFail||"").toUpperCase()==="FAIL"){u.error("FAIL â€” HR decision required"),N({requirementId:e.requirementId,candidateId:e.candidateId,candidateName:e.candidateName,candidateNameFull:e.candidateNameFull,mobile:e.mobile,mobileFull:e.mobileFull,testType:n.testType||"INPERSON_MARKS",stageTag:n.stageTag||"In-person Marks",marks:{inPersonMarks:r}}),j("");return}u.success("Marks saved"),U(c=>c.map(i=>i.candidateId===e.candidateId?{...i,inPersonMarks:r,inPersonMarksAt:new Date().toISOString()}:i))}catch(n){u.error((n==null?void 0:n.message)||"Failed")}finally{v("")}}function ae(e,a){D(r=>{const t=Array.isArray(r[e])?r[e]:[],c=t.includes(a)?t.filter(i=>i!==a):[...t,a];return{...r,[e]:c}})}function re(e){const a=String(e||"").toUpperCase();return a==="APPROVED"?{background:"#22c55e",color:"#fff"}:a==="REJECTED"?{background:"#ef4444",color:"#fff"}:a==="REVIEW_PENDING"?{background:"#f59e0b",color:"#fff"}:a==="PENDING"?{background:"var(--gray-200)",color:"var(--gray-800)"}:{background:"var(--gray-100)",color:"var(--gray-700)"}}function te(e){const a=String(e||"").toUpperCase();return a==="APPROVED"?"PASS":a==="REJECTED"?"FAIL":a==="REVIEW_PENDING"?"REVIEW PENDING":a==="NOT_SELECTED"?"NOT SELECTED":a||"-"}async function ne(e){if(!g("CANDIDATE_REQUIRED_TESTS_SET",["HR","ADMIN"])){u.error("Not allowed");return}const a=`${e.candidateId}:REQ_TESTS`;v(a);try{const r=w[e.candidateId]??[],t=await ye(l,{requirementId:e.requirementId,candidateId:e.candidateId,testKeys:r});C(i=>({...i,[e.candidateId]:t}));const n=(t==null?void 0:t.requiredTests)??[],c=Array.isArray(n)?n.map(i=>i.testKey).filter(Boolean):[];D(i=>({...i,[e.candidateId]:c})),u.success("Required tests updated")}catch(r){u.error((r==null?void 0:r.message)||"Failed")}finally{v("")}}async function ie(e){const a=w[e.candidateId]??[],r=[`Name: ${y(e)||e.candidateId}`,`Role: ${e.jobRole}${e.jobTitle?` (${e.jobTitle})`:""}`,`Online Test: ${e.onlineTestResult} ${e.onlineTestScore!==""?`(${e.onlineTestScore}/10)`:""}`,`In-person Marks: ${E[e.candidateId]??e.inPersonMarks??""}`,`Required Tests: ${(Array.isArray(a)?a:[]).join(", ")}`].join(`
`);try{await navigator.clipboard.writeText(r),u.success("Copied")}catch{u.error("Copy failed")}}const de=()=>S(p);return s.jsxs(ce,{children:[o?s.jsxs("div",{className:"card",style:{marginBottom:12,border:"1px solid var(--gray-200)"},children:[s.jsx("div",{style:{fontWeight:800,marginBottom:6},children:"In-person FAIL â€” HR decision required"}),s.jsxs("div",{className:"small",style:{color:"var(--gray-600)",marginBottom:10},children:[y(o)||o.candidateId," Â· ",o.stageTag]}),s.jsx("div",{className:"small",style:{marginBottom:6,fontWeight:700},children:"Remark (required only if Reject)"}),s.jsx("textarea",{value:q,onChange:e=>j(e.target.value),rows:2,style:{width:"100%"}}),s.jsxs("div",{style:{display:"flex",gap:8,marginTop:10,flexWrap:"wrap"},children:[s.jsx("button",{className:"button",type:"button",onClick:async()=>{try{await J(l,{requirementId:o.requirementId,candidateId:o.candidateId,testType:o.testType,decision:"CONTINUE",remark:String(q||"").trim(),stageTag:o.stageTag,meta:{marks:o.marks}}),u.success("Override applied (Continued)"),N(null),j(""),await S(p)}catch(e){u.error((e==null?void 0:e.message)||"Failed")}},disabled:!!f,children:"Continue"}),s.jsx("button",{className:"button danger",type:"button",onClick:async()=>{const e=String(q||"").trim();if(!e){u.error("Remark is required to Reject");return}try{await J(l,{requirementId:o.requirementId,candidateId:o.candidateId,testType:o.testType,decision:"REJECT",remark:e,stageTag:o.stageTag,meta:{marks:o.marks}}),ue({requirementId:o.requirementId,candidateId:o.candidateId}),u.success("Rejected"),N(null),j(""),await S(p)}catch(a){u.error((a==null?void 0:a.message)||"Failed")}},disabled:!!f,children:"Reject"}),s.jsx("button",{className:"button",type:"button",onClick:()=>N(null),disabled:!!f,children:"Close"})]})]}):null,h?null:s.jsxs("div",{className:"card",style:{padding:12,marginBottom:12},children:[s.jsx("div",{style:{fontWeight:700},children:"Not allowed"}),s.jsx("div",{className:"small",style:{color:"var(--gray-600)"},children:"You donâ€™t have access to In-person portal."})]}),s.jsxs("div",{style:{marginBottom:"20px"},children:[s.jsx("h1",{className:"page-title",children:"In-person Interview"}),s.jsx("p",{className:"page-subtitle",children:"Shows candidates who passed the online test"})]}),s.jsxs("div",{className:"card",style:{marginBottom:"16px"},children:[s.jsxs("div",{className:"row",style:{gap:12,alignItems:"flex-end",flexWrap:"wrap"},children:[s.jsxs("button",{className:"button",onClick:de,disabled:A,style:{display:"flex",alignItems:"center",gap:6},children:[A?s.jsx(F,{size:14}):null,"Refresh"]}),s.jsx("div",{style:{marginLeft:"auto"},children:s.jsxs("span",{className:"badge",children:[b.length," candidates"]})})]}),s.jsx("div",{style:{height:12}}),s.jsx("div",{className:"tabs",children:Z.map(e=>s.jsx("button",{className:["tab",p===e?"active":""].join(" "),onClick:()=>Y(e),type:"button",children:e},e))})]}),A?s.jsx(me,{text:"Loading candidates..."}):s.jsxs(s.Fragment,{children:[s.jsx(L,{title:"In-person Marks FAIL (Decision Required)",subtitle:"Candidates with marks < 6 must be Continued/Rejected by HR",badge:k.length,variant:"card",defaultOpen:k.length>0,children:k.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("div",{className:"empty-state-icon",children:"âœ…"}),s.jsx("div",{className:"empty-state-text",children:"No pending decisions"})]}):s.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:10},children:k.map(e=>{const a=Number(e.inPersonMarks);return s.jsx("div",{className:"card",style:{background:"#fff",border:"1px solid var(--gray-200)"},children:s.jsxs("div",{className:"row",style:{alignItems:"center",gap:12,flexWrap:"wrap"},children:[s.jsxs("div",{style:{minWidth:240},children:[s.jsxs("div",{style:{fontWeight:700,fontSize:"15px"},children:[y(e)||e.candidateId,y(e)&&e.candidateId?s.jsxs("span",{className:"small",style:{fontWeight:400,marginLeft:8,color:"var(--gray-500)"},children:["(",e.candidateId,")"]}):null]}),s.jsxs("div",{className:"small",style:{color:"var(--gray-500)",marginTop:2},children:[e.jobTitle?`${e.jobTitle} Â· `:"",e.jobRole||"-"]}),s.jsxs("div",{style:{marginTop:6,display:"flex",gap:8,flexWrap:"wrap"},children:[s.jsxs("span",{className:"badge",style:{background:"#ef4444",color:"#fff"},children:["In-person: ",e.inPersonMarks,"/10"]}),s.jsx("span",{className:"badge",style:{background:"#ef4444",color:"#fff"},children:"Decision Required"})]}),s.jsx("div",{style:{marginTop:8},children:s.jsx(W,{sla:e.sla})})]}),s.jsxs("div",{className:"action-grid",style:{marginLeft:"auto"},children:[s.jsx(O,{cvFileId:e.cvFileId,token:l}),s.jsx("button",{className:"button",type:"button",onClick:()=>{N({requirementId:e.requirementId,candidateId:e.candidateId,candidateName:e.candidateName,candidateNameFull:e.candidateNameFull,mobile:e.mobile,mobileFull:e.mobileFull,testType:"INPERSON_MARKS",stageTag:"In-person Marks",marks:{inPersonMarks:Number.isFinite(a)?a:e.inPersonMarks}}),j("")},disabled:!!f||!g("TEST_FAIL_DECIDE",["HR","ADMIN"]),children:"Decide (Continue/Reject)"})]})]})},e.candidateId)})})}),s.jsx("div",{style:{height:16}}),s.jsx(L,{title:"Pending In-person Marks",subtitle:"Candidates awaiting in-person interview marks",badge:P.length,variant:"card",defaultOpen:!0,children:P.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("div",{className:"empty-state-icon",children:"ðŸ“"}),s.jsx("div",{className:"empty-state-text",children:"No candidates pending marks"})]}):s.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:10},children:P.map(e=>{const a=`${e.candidateId}:MARKS`;return s.jsx("div",{className:"card",style:{background:"#fff",border:"1px solid var(--gray-200)"},children:s.jsxs("div",{className:"row",style:{alignItems:"center",gap:12,flexWrap:"wrap"},children:[s.jsxs("div",{style:{minWidth:240},children:[s.jsxs("div",{style:{fontWeight:700,fontSize:"15px"},children:[y(e)||e.candidateId,y(e)&&e.candidateId?s.jsxs("span",{className:"small",style:{fontWeight:400,marginLeft:8,color:"var(--gray-500)"},children:["(",e.candidateId,")"]}):null]}),s.jsxs("div",{className:"small",style:{color:"var(--gray-500)",marginTop:2},children:[e.jobTitle?`${e.jobTitle} Â· `:"",e.jobRole||"-"]}),s.jsxs("div",{style:{marginTop:6,display:"flex",gap:8,flexWrap:"wrap"},children:[s.jsxs("span",{className:"badge",style:{background:String(e.onlineTestResult||"").toUpperCase()==="PASS"?"#22c55e":"#ef4444",color:"#fff"},children:["Online: ",String(e.onlineTestResult||"").toUpperCase()]}),String(e.onlineTestResult||"").toUpperCase()==="FAIL"&&T(e,"ONLINE_TEST")?s.jsx("span",{className:"badge",style:{background:"#f59e0b",color:"#fff"},children:"HR Override Applied"}):null,e.onlineTestScore!==""?s.jsxs("span",{className:"badge",children:["Score: ",e.onlineTestScore,"/10"]}):null]}),s.jsx("div",{style:{marginTop:8},children:s.jsx(W,{sla:e.sla})})]}),s.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",marginLeft:"auto"},children:[s.jsx(O,{cvFileId:e.cvFileId,token:l}),s.jsx("input",{style:{width:90},placeholder:"Marks",value:E[e.candidateId]??"",onChange:r=>V(t=>({...t,[e.candidateId]:r.target.value}))}),s.jsxs("button",{className:"button primary",type:"button",onClick:()=>se(e),disabled:!!f||!g("INPERSON_MARKS_SAVE",["HR","ADMIN"]),children:[f===a?s.jsx(F,{size:14}):null,"Save"]})]})]})},e.candidateId)})})}),s.jsx("div",{style:{height:16}}),s.jsx(L,{title:"Required Tests (Marks â‰¥ 6 or HR override)",subtitle:"Select required tests for qualified candidates",badge:_.length,variant:"card",defaultOpen:!0,children:_.length===0?s.jsxs("div",{className:"empty-state",children:[s.jsx("div",{className:"empty-state-icon",children:"âš™ï¸"}),s.jsx("div",{className:"empty-state-text",children:"No candidates ready for required tests"})]}):s.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:10},children:_.map(e=>{var i;const a=Number(e.inPersonMarks),r=T(e,"INPERSON_MARKS"),t=`${e.candidateId}:REQ_TESTS`,n=w[e.candidateId]??[],c=((i=M==null?void 0:M[e.candidateId])==null?void 0:i.requiredTests)??[];return s.jsxs("div",{className:"card",style:{background:"#fff",border:"1px solid var(--gray-200)"},children:[s.jsxs("div",{className:"row",style:{alignItems:"flex-start",gap:12,flexWrap:"wrap"},children:[s.jsxs("div",{style:{minWidth:240},children:[s.jsxs("div",{style:{fontWeight:700,fontSize:"15px"},children:[y(e)||e.candidateId,y(e)&&e.candidateId?s.jsxs("span",{className:"small",style:{fontWeight:400,marginLeft:8,color:"var(--gray-500)"},children:["(",e.candidateId,")"]}):null]}),s.jsxs("div",{className:"small",style:{color:"var(--gray-500)",marginTop:2},children:[e.jobTitle?`${e.jobTitle} Â· `:"",e.jobRole||"-"]}),s.jsxs("div",{style:{marginTop:6,display:"flex",gap:8,flexWrap:"wrap"},children:[s.jsxs("span",{className:"badge",style:{background:a>=6?"#22c55e":"#ef4444",color:"#fff"},children:["In-person: ",e.inPersonMarks,"/10"]}),Number.isFinite(a)&&a<6?r?s.jsx("span",{className:"badge",style:{background:"#f59e0b",color:"#fff"},children:"HR Override Applied"}):s.jsx("span",{className:"badge",style:{background:"#ef4444",color:"#fff"},children:"Decision Required"}):null,e.inPersonMarksAt?s.jsxs("span",{className:"badge",children:["ðŸ“… ",he(e.inPersonMarksAt)]}):null]}),s.jsx("div",{style:{marginTop:8},children:s.jsx(W,{sla:e.sla})}),s.jsx("div",{style:{marginTop:10},children:s.jsx(O,{cvFileId:e.cvFileId,token:l})})]}),s.jsx("div",{style:{marginLeft:"auto",display:"flex",gap:10,flexWrap:"wrap",alignItems:"center"},children:s.jsx("button",{className:"button",type:"button",onClick:()=>ie(e),children:"ðŸ“‹ Copy"})})]}),s.jsx("div",{style:{height:12}}),s.jsxs("div",{style:{padding:"10px 12px",background:"var(--gray-50)",borderRadius:"var(--radius)",border:"1px solid var(--gray-200)"},children:[s.jsx("div",{className:"small",style:{fontWeight:700,marginBottom:8},children:"Required Tests (HR)"}),G.length===0?s.jsx("div",{className:"small",style:{color:"var(--gray-600)"},children:"No tests configured in Test Master."}):s.jsx("div",{style:{display:"flex",gap:12,flexWrap:"wrap"},children:G.map(m=>s.jsxs("label",{style:{display:"flex",gap:6,alignItems:"center",fontSize:"14px",cursor:"pointer"},children:[s.jsx("input",{type:"checkbox",checked:n.includes(m.testKey),onChange:()=>ae(e.candidateId,m.testKey)}),m.label||m.testKey]},m.testKey))}),s.jsx("div",{style:{height:10}}),s.jsxs("div",{className:"row",style:{alignItems:"center",gap:12,flexWrap:"wrap"},children:[s.jsxs("button",{className:"button primary",type:"button",onClick:()=>ne(e),disabled:!!f||!g("CANDIDATE_REQUIRED_TESTS_SET",["HR","ADMIN"]),children:[f===t?s.jsx(F,{size:14}):null,"Submit Required Tests"]}),Array.isArray(c)&&c.length?s.jsxs("span",{className:"badge",children:[c.length," selected"]}):null]}),Array.isArray(c)&&c.length?s.jsx("div",{style:{marginTop:10,display:"flex",gap:8,flexWrap:"wrap"},children:c.map(m=>s.jsxs("span",{className:"badge",style:re(m.status),children:[m.label||m.testKey,": ",te(m.status)]},m.testKey))}):null]})]},e.candidateId)})})})]})]})}export{Re as InpersonTechPage};
