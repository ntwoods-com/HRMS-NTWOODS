import{a as F,r as j,j as e,A as P,S as A,M as H,a6 as q,n as i,a7 as z,a8 as K,a9 as G,aa as V}from"./index-grL27em3.js";import{C as Y}from"./Collapsible-0ER5Bbk1.js";import{v as Q}from"./scheduling-mgpGDE0C.js";import{o as X}from"./files-CjotXup9.js";import{V as Z}from"./ViewCvButton-Cqus7HoZ.js";import{c as k}from"./pii-BcFV6mqh.js";import{S as R}from"./SlaCountdown-DTF7N97H.js";import{u as ee,t as ae,f as J,a as se}from"./useNowTick-_9wyDYsU.js";function te(r){if(!r)return"";const l=r instanceof Date?r:new Date(r);if(Number.isNaN(l.getTime()))return"";const d=D=>String(D).padStart(2,"0"),c=l.getFullYear(),g=d(l.getMonth()+1),u=d(l.getDate()),m=d(l.getHours()),v=d(l.getMinutes());return`${c}-${g}-${u}T${m}:${v}`}function ne({joiningAt:r}){const l=ee(),d=ae(r);if(d==null)return e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx("div",{className:"small",style:{color:"var(--gray-500)"},children:"Joining Date"}),e.jsx("div",{style:{fontWeight:700,fontSize:"15px",marginTop:2},children:"Not set"})]});const c=d-l,g=c<=0,u=g?`OVERDUE by ${J(-c)}`:`${J(c)} left`;return e.jsxs("div",{style:{textAlign:"right"},children:[e.jsx("div",{className:"small",style:{color:"var(--gray-500)"},children:"Joining Date"}),e.jsx("div",{style:{fontWeight:700,fontSize:"15px",marginTop:2},children:se(d)||"-"}),e.jsx("div",{style:{marginTop:4},children:e.jsx("span",{className:"badge",style:{background:g?"#ef4444":"#22c55e",color:"#fff",fontFamily:"monospace"},children:u})})]})}async function ie(r){return new Promise((l,d)=>{const c=new FileReader;c.onload=()=>{const g=String(c.result||""),u=g.indexOf(",");if(u===-1){d(new Error("Invalid file encoding"));return}l(g.slice(u+1))},c.onerror=()=>d(new Error("Failed to read file")),c.readAsDataURL(r)})}function pe(){const{token:r,role:l,legacyRole:d,canPortal:c,canAction:g}=F();function u(a,n){const s=typeof c=="function"?c(a):null;if(s===!0||s===!1)return s;const t=String(d||l||"").toUpperCase();return Array.isArray(n)?n.includes(t):!1}function m(a,n){const s=typeof g=="function"?g(a):null;if(s===!0||s===!1)return s;const t=String(d||l||"").toUpperCase();return Array.isArray(n)?n.includes(t):!1}const v=u("PORTAL_HR_JOINING",["HR","ADMIN"]),[D,S]=j.useState(!1),[b,L]=j.useState([]),[p,f]=j.useState(""),[w,C]=j.useState({}),[O,M]=j.useState({});async function I(){if(v&&m("JOINING_LIST",["HR","ADMIN"])){S(!0);try{const n=(await q(r)).items||[];L(n),C(s=>{const t={...s};return n.forEach(o=>{t[o.candidateId]||(t[o.candidateId]={joiningAt:te(o.joiningAt),remark:""})}),t})}catch(a){i.error((a==null?void 0:a.message)||"Failed to load")}finally{S(!1)}}}j.useEffect(()=>{I()},[v]);const T=j.useMemo(()=>b.length,[b]);async function E(a){if(!m("JOINING_SET_DATE",["HR","ADMIN"])){i.error("Not allowed");return}const n=w[a.candidateId]||{},s=String(n.joiningAt||"").trim();if(!s){i.error("Select joining date/time");return}const t=Q(s);if(!t.ok){i.error(t.message);return}const o=t.date,y=`${a.candidateId}:SET_DATE`;f(y);try{await z(r,{requirementId:a.requirementId,candidateId:a.candidateId,joiningAt:o.toISOString()}),i.success("Joining date set"),await I()}catch(x){i.error((x==null?void 0:x.message)||"Failed")}finally{f("")}}async function _(a){if(!m("DOCS_UPLOAD",["HR","ADMIN"])){i.error("Not allowed");return}const n=O[a.candidateId]||[];if(!n.length){i.error("Select documents first");return}const s=`${a.candidateId}:DOCS_UPLOAD`;f(s);try{const t=[];for(let o=0;o<n.length;o+=1){const y=n[o],x=await ie(y);t.push({filename:y.name,mimeType:y.type||"application/octet-stream",base64:x,docType:""})}await K(r,{requirementId:a.requirementId,candidateId:a.candidateId,docs:t}),i.success("Docs uploaded"),M(o=>({...o,[a.candidateId]:[]})),await I()}catch(t){i.error((t==null?void 0:t.message)||"Upload failed")}finally{f("")}}async function $(a){if(!m("DOCS_COMPLETE",["HR","ADMIN"])){i.error("Not allowed");return}const n=`${a.candidateId}:DOCS_COMPLETE`;f(n);try{await G(r,{requirementId:a.requirementId,candidateId:a.candidateId}),i.success("Docs marked complete"),await I()}catch(s){i.error((s==null?void 0:s.message)||"Failed")}finally{f("")}}async function U(a){if(!m("MARK_JOIN",["HR","ADMIN"])){i.error("Not allowed");return}const n=`${a.candidateId}:MARK_JOIN`;f(n);try{await V(r,{requirementId:a.requirementId,candidateId:a.candidateId,remark:""}),i.success("Marked joined"),await I()}catch(s){i.error((s==null?void 0:s.message)||"Failed")}finally{f("")}}function W(a){if(!a)return;X(a,r)||i.error("Unable to open file")}return e.jsxs(P,{children:[v?null:e.jsxs("div",{className:"card",style:{padding:12,marginBottom:12},children:[e.jsx("div",{style:{fontWeight:700},children:"Not allowed"}),e.jsx("div",{className:"small",style:{color:"var(--gray-600)"},children:"You don‚Äôt have access to Joining portal."})]}),e.jsxs("div",{style:{marginBottom:"20px"},children:[e.jsx("h1",{className:"page-title",children:"Joining"}),e.jsx("p",{className:"page-subtitle",children:"Manage candidate joining process and documentation"})]}),e.jsx("div",{className:"card",style:{marginBottom:"16px"},children:e.jsxs("div",{className:"row",style:{gap:12,alignItems:"flex-end",flexWrap:"wrap"},children:[e.jsxs("button",{className:"button",onClick:I,disabled:D,style:{display:"flex",alignItems:"center",gap:6},children:[D?e.jsx(A,{size:14}):null,"Refresh"]}),e.jsx("div",{style:{marginLeft:"auto"},children:e.jsxs("span",{className:"badge",children:[T," candidates"]})})]})}),D?e.jsx(H,{text:"Loading candidates..."}):e.jsx(Y,{title:"Joining Candidates",subtitle:"Set joining date, upload docs, and mark joined",badge:T,variant:"card",defaultOpen:!0,children:b.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("div",{className:"empty-state-icon",children:"üéâ"}),e.jsx("div",{className:"empty-state-text",children:"No candidates in Joining"})]}):e.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:12},children:b.map(a=>{const n=String(a.status||"").toUpperCase(),s=n==="JOINING",t=!!a.docsCompleteAt,o=Array.isArray(a.docs)&&a.docs.length>0,y=w[a.candidateId]||{joiningAt:"",remark:""},x=O[a.candidateId]||[];return e.jsx("div",{className:"card",style:{background:"#fff",border:"1px solid var(--gray-200)"},children:e.jsxs("div",{style:{display:"grid",gap:16},children:[e.jsxs("div",{className:"row",style:{alignItems:"flex-start",gap:12,flexWrap:"wrap"},children:[e.jsxs("div",{style:{flex:1,minWidth:240},children:[e.jsxs("div",{style:{fontWeight:700,fontSize:"16px"},children:[k(a)||a.candidateId,k(a)&&a.candidateId?e.jsxs("span",{className:"small",style:{fontWeight:400,marginLeft:8,color:"var(--gray-500)"},children:["(",a.candidateId,")"]}):null]}),e.jsxs("div",{className:"small",style:{color:"var(--gray-500)",marginTop:2},children:[a.jobTitle?`${a.jobTitle} ¬∑ `:"",a.jobRole||"-"]}),e.jsxs("div",{style:{marginTop:8,display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsxs("span",{className:"badge",children:["Req: ",a.requirementId]}),e.jsx("span",{className:"badge",style:{background:"var(--primary)",color:"#fff"},children:n}),e.jsx(Z,{cvFileId:a.cvFileId,token:r})]}),e.jsx("div",{style:{marginTop:8},children:e.jsx(R,{sla:a.sla})})]}),e.jsx(ne,{joiningAt:a.joiningAt})]}),e.jsxs("div",{style:{padding:"12px",background:"var(--gray-50)",borderRadius:"var(--radius)"},children:[e.jsx("div",{className:"small",style:{fontWeight:700,marginBottom:8},children:"üìÖ Set Joining Date"}),e.jsxs("div",{className:"row",style:{gap:8,flexWrap:"wrap",alignItems:"flex-end"},children:[e.jsx("input",{type:"datetime-local",value:y.joiningAt,onChange:h=>C(N=>({...N,[a.candidateId]:{...y,joiningAt:h.target.value}})),style:{flex:1,minWidth:200}}),e.jsxs("button",{className:"button primary",type:"button",onClick:()=>E(a),disabled:!!p||!m("JOINING_SET_DATE",["HR","ADMIN"]),children:[p===`${a.candidateId}:SET_DATE`?e.jsx(A,{size:14}):null,"Set Date"]})]})]}),e.jsxs("div",{style:{padding:"12px",background:"var(--gray-50)",borderRadius:"var(--radius)"},children:[e.jsxs("div",{className:"small",style:{fontWeight:700,marginBottom:8},children:["üìÑ Docs Verification",o&&e.jsxs("span",{className:"badge",style:{marginLeft:8},children:[a.docs.length," uploaded"]}),t&&e.jsx("span",{className:"badge",style:{marginLeft:8,background:"#22c55e",color:"#fff"},children:"‚úì Complete"})]}),t?null:e.jsx("div",{style:{marginBottom:8},children:e.jsx(R,{sla:a.docsSla})}),o&&e.jsx("div",{style:{marginBottom:10,display:"flex",gap:6,flexWrap:"wrap"},children:a.docs.slice(0,5).map((h,N)=>e.jsxs("button",{className:"button",type:"button",onClick:()=>W(h.fileId),style:{fontSize:"12px",padding:"4px 8px"},children:["üìÑ Doc ",N+1]},`${a.candidateId}:doc:${N}`))}),e.jsx("input",{type:"file",multiple:!0,disabled:!m("DOCS_UPLOAD",["HR","ADMIN"]),onChange:h=>{const N=Array.from(h.target.files||[]);M(B=>({...B,[a.candidateId]:N}))},style:{marginBottom:8}}),x.length>0&&e.jsxs("div",{className:"small",style:{marginBottom:8,color:"var(--gray-600)"},children:["Selected: ",x.map(h=>h.name).join(", ")]}),e.jsxs("div",{className:"action-grid",children:[e.jsxs("button",{className:"button",type:"button",onClick:()=>_(a),disabled:!!p||!m("DOCS_UPLOAD",["HR","ADMIN"]),children:[p===`${a.candidateId}:DOCS_UPLOAD`?e.jsx(A,{size:14}):null,"Upload Docs"]}),e.jsxs("button",{className:"button",type:"button",onClick:()=>$(a),disabled:!o||!!p||!m("DOCS_COMPLETE",["HR","ADMIN"]),children:[p===`${a.candidateId}:DOCS_COMPLETE`?e.jsx(A,{size:14}):null,"Docs Complete"]})]})]}),e.jsxs("div",{style:{padding:"12px",background:s&&t?"#dcfce7":"var(--gray-50)",borderRadius:"var(--radius)"},children:[e.jsx("div",{className:"small",style:{fontWeight:700,marginBottom:8},children:"üéâ Mark Join"}),e.jsxs("button",{className:"button primary",type:"button",onClick:()=>U(a),disabled:!s||!t||!!p||!m("MARK_JOIN",["HR","ADMIN"]),style:{width:"100%"},children:[p===`${a.candidateId}:MARK_JOIN`?e.jsx(A,{size:14}):null,"Mark Joined"]}),!s&&e.jsx("div",{className:"small",style:{marginTop:6,color:"var(--gray-500)"},children:"‚ö†Ô∏è Locked until joining date is set"}),s&&!t&&e.jsx("div",{className:"small",style:{marginTop:6,color:"var(--gray-500)"},children:"‚ö†Ô∏è Locked until docs complete"})]})]})},a.candidateId)})})})]})}export{pe as JoiningPage};
