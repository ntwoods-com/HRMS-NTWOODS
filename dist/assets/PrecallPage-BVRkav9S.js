import{a as M,r as i,j as t,h as q,S as h,_ as B,a4 as W,n as l,a5 as C,a6 as v}from"./index-DOrSdxar.js";import{V as $}from"./ViewCvButton-iWa9D0rl.js";import{c as H}from"./pii-BcFV6mqh.js";import{S as O}from"./SlaCountdown-Dbjbgs8L.js";import"./files-C2YBokWG.js";import"./useNowTick-jLJk1rJb.js";function U(){const r=new Date,o=r.getFullYear(),g=String(r.getMonth()+1).padStart(2,"0"),y=String(r.getDate()).padStart(2,"0");return`${o}-${g}-${y}`}function F(r){if(!r)return"";const o=r instanceof Date?r:new Date(r);return Number.isNaN(o.getTime())?String(r):o.toLocaleString()}function Q(){const{token:r,role:o,legacyRole:g,canPortal:y,canAction:L}=M();function k(e,s){const a=typeof y=="function"?y(e):null;if(a===!0||a===!1)return a;const n=String(g||o||"").toUpperCase();return Array.isArray(s)?s.includes(n):!1}function c(e,s){const a=typeof L=="function"?L(e):null;if(a===!0||a===!1)return a;const n=String(g||o||"").toUpperCase();return Array.isArray(s)?s.includes(n):!1}const I=k("PORTAL_HR_PRECALL",["HR","ADMIN"]),[x,w]=i.useState(U()),[u,D]=i.useState("ALL"),[N,R]=i.useState(!1),[p,f]=i.useState([]),[j,m]=i.useState(""),E=i.useMemo(()=>{const e=Array.from(new Set(p.map(s=>s.jobRole).filter(Boolean)));return e.sort((s,a)=>String(s).localeCompare(String(a))),["ALL",...e]},[p]);async function b(e,s){if(I&&c("PRECALL_LIST",["HR","ADMIN"])){R(!0);try{const d=(await W(r,{date:e,jobRole:s&&s!=="ALL"?s:""})).items??[];f(d.filter(P=>!P.preCallAt&&!P.onlineTestResult))}catch(a){l.error((a==null?void 0:a.message)||"Failed to load")}finally{R(!1)}}}i.useEffect(()=>{b(x,u)},[x,u,I]);const A=i.useMemo(()=>u==="ALL"?p:p.filter(e=>e.jobRole===u),[p,u]);i.useMemo(()=>null,[]);async function S(e){if(!c("PRECALL_UPDATE",["HR","ADMIN"])){l.error("Not allowed");return}const s=`${e.candidateId}:NOT_PICK`;m(s);try{const a=await C(r,{requirementId:e.requirementId,candidateId:e.candidateId,op:"NOT_PICK"});if(a.autoRejected||a.status==="REJECTED"){v({requirementId:e.requirementId,candidateId:e.candidateId}),l.success("Auto rejected (Not Pick threshold)"),f(n=>n.filter(d=>d.candidateId!==e.candidateId));return}l.success("Marked Not Pick"),f(n=>n.map(d=>d.candidateId===e.candidateId?{...d,notPickCount:a.notPickCount??(d.notPickCount??0)+1}:d))}catch(a){l.error((a==null?void 0:a.message)||"Failed")}finally{m("")}}async function T(e){if(!c("PRECALL_UPDATE",["HR","ADMIN"])){l.error("Not allowed");return}const s=`${e.candidateId}:CALL_DONE`;m(s);try{const a=new Date().toISOString();await C(r,{requirementId:e.requirementId,candidateId:e.candidateId,op:"CALL_DONE",preCallAt:a}),l.success("Call marked done"),f(n=>n.filter(d=>d.candidateId!==e.candidateId))}catch(a){l.error((a==null?void 0:a.message)||"Failed")}finally{m("")}}async function _(e){if(!c("PRECALL_UPDATE",["HR","ADMIN"])){l.error("Not allowed");return}const s=window.prompt("Reject remark (required):");if(s==null)return;if(!String(s).trim()){l.error("Remark required");return}const a=`${e.candidateId}:REJECT`;m(a);try{await C(r,{requirementId:e.requirementId,candidateId:e.candidateId,op:"REJECT",remark:String(s).trim()}),v({requirementId:e.requirementId,candidateId:e.candidateId}),l.success("Rejected"),f(n=>n.filter(d=>d.candidateId!==e.candidateId))}catch(n){l.error((n==null?void 0:n.message)||"Failed")}finally{m("")}}return t.jsxs(q,{children:[I?null:t.jsxs("div",{className:"card",style:{padding:12,marginBottom:12},children:[t.jsx("div",{style:{fontWeight:700},children:"Not allowed"}),t.jsx("div",{className:"small",style:{color:"var(--gray-600)"},children:"You donâ€™t have access to Precall portal."})]}),t.jsxs("div",{style:{marginBottom:"20px"},children:[t.jsx("h1",{className:"page-title",children:"Pre-interview Calls"}),t.jsx("p",{className:"page-subtitle",children:"Track walk-in candidates and mark call status"})]}),t.jsx("div",{className:"card",style:{marginBottom:"16px"},children:t.jsxs("div",{className:"row",style:{gap:16,alignItems:"center",flexWrap:"wrap"},children:[t.jsxs("div",{children:[t.jsx("label",{className:"small",style:{display:"block",marginBottom:"4px",fontWeight:500},children:"Walk-in Date"}),t.jsx("input",{type:"date",value:x,onChange:e=>w(e.target.value)})]}),t.jsx("div",{className:"spacer"}),t.jsx("button",{className:"button",onClick:()=>b(x,u),disabled:N,children:N?t.jsxs(t.Fragment,{children:[t.jsx(h,{size:14})," Refreshing..."]}):"â†» Refresh"}),t.jsxs("span",{className:"badge blue",children:[A.length," candidates"]})]})}),t.jsx("div",{className:"tabs",style:{marginBottom:"16px"},children:E.map(e=>t.jsx("button",{className:["tab",u===e?"active":""].join(" "),onClick:()=>D(e),type:"button",children:e},e))}),N?t.jsx(B,{text:"Loading candidates..."}):A.length===0?t.jsxs("div",{className:"card",style:{textAlign:"center",padding:"40px"},children:[t.jsx("div",{style:{fontSize:"48px",marginBottom:"12px"},children:"ðŸ“ž"}),t.jsx("p",{className:"small",children:"No scheduled walk-ins for this filter."})]}):t.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:12},children:A.map(e=>{const s=j.startsWith(e.candidateId),a=H(e);return t.jsx("div",{className:"card",children:t.jsxs("div",{className:"row",style:{alignItems:"flex-start",gap:16,flexWrap:"wrap"},children:[t.jsxs("div",{style:{flex:1},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px",marginBottom:"8px"},children:[t.jsxs("div",{style:{fontWeight:600,fontSize:"16px"},children:[a||e.candidateId,a&&e.candidateId?t.jsxs("span",{className:"small",style:{fontWeight:400,marginLeft:8,color:"var(--gray-500)"},children:["(",e.candidateId,")"]}):null]}),t.jsxs("span",{className:"badge orange",children:["Not Pick: ",Number(e.notPickCount||0)]})]}),t.jsx(O,{sla:e.sla}),t.jsxs("div",{className:"small",style:{display:"grid",gap:"4px"},children:[t.jsxs("div",{children:[t.jsx("strong",{children:"Position:"})," ",e.jobTitle?`${e.jobTitle} Â· `:"",e.jobRole]}),t.jsxs("div",{children:[t.jsx("strong",{children:"Walk-in:"})," ",F(e.walkinAt)]}),e.walkinNotes&&t.jsxs("div",{children:[t.jsx("strong",{children:"Notes:"})," ",e.walkinNotes]})]})]}),t.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[t.jsx($,{cvFileId:e.cvFileId,token:r}),t.jsxs("button",{className:"button",type:"button",onClick:()=>S(e),disabled:s||!c("PRECALL_UPDATE",["HR","ADMIN"]),children:[j===`${e.candidateId}:NOT_PICK`?t.jsx(h,{size:14}):"ðŸ“µ"," Not Pick"]}),t.jsxs("button",{className:"button success",type:"button",onClick:()=>T(e),disabled:s||!c("PRECALL_UPDATE",["HR","ADMIN"]),children:[j===`${e.candidateId}:CALL_DONE`?t.jsx(h,{size:14}):"âœ“"," Call Done"]}),t.jsxs("button",{className:"button danger",type:"button",onClick:()=>_(e),disabled:s||!c("PRECALL_UPDATE",["HR","ADMIN"]),children:[j===`${e.candidateId}:REJECT`?t.jsx(h,{size:14}):"âœ•"," Reject"]})]})]})},e.candidateId)})})]})}export{Q as PrecallPage};
