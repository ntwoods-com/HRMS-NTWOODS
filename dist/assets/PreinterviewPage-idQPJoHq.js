import{a as ae,r as p,j as t,A as re,S as N,M as ne,T as se,n as s,W as C,V as de,X as ie,Y as le,Z as _}from"./index-grL27em3.js";import{C as $}from"./Collapsible-0ER5Bbk1.js";import{V as H}from"./ViewCvButton-Cqus7HoZ.js";import{c as A}from"./pii-BcFV6mqh.js";import{S as F}from"./SlaCountdown-DTF7N97H.js";import"./files-CjotXup9.js";import"./useNowTick-_9wyDYsU.js";function oe(){const i=new Date,I=i.getFullYear(),c=String(i.getMonth()+1).padStart(2,"0"),f=String(i.getDate()).padStart(2,"0");return`${I}-${c}-${f}`}function D(i){if(!i)return"";const I=i instanceof Date?i:new Date(i);return Number.isNaN(I.getTime())?String(i):I.toLocaleString()}function ce(i,I){const c=I?new Date(I):null,f=g=>String(g).padStart(2,"0"),T=c&&!Number.isNaN(c.getTime())?`${c.getFullYear()}-${f(c.getMonth()+1)}-${f(c.getDate())}T${f(c.getHours())}:${f(c.getMinutes())}`:"",R=window.prompt(i+" (YYYY-MM-DDTHH:mm):",T);if(R==null)return null;const l=String(R).trim();if(!l)return"";const h=new Date(l);return Number.isNaN(h.getTime())?"INVALID":h.toISOString()}function he(){const{token:i,role:I,legacyRole:c,canPortal:f,canAction:T}=ae();function R(e,a){const r=typeof f=="function"?f(e):null;if(r===!0||r===!1)return r;const n=String(c||I||"").toUpperCase();return Array.isArray(a)?a.includes(n):!1}function l(e,a){const r=typeof T=="function"?T(e):null;if(r===!0||r===!1)return r;const n=String(c||I||"").toUpperCase();return Array.isArray(a)?a.includes(n):!1}const h=R("PORTAL_HR_PREINTERVIEW",["HR","ADMIN"]),[g,W]=p.useState(oe()),[y,q]=p.useState("ALL"),[b,L]=p.useState(!1),[x,j]=p.useState([]),[M,U]=p.useState({}),[P,O]=p.useState({}),[u,o]=p.useState("");function V(e,a){try{const r=JSON.parse(String((e==null?void 0:e.testDecisionsJson)||"{}")),n=r==null?void 0:r[a];return String((n==null?void 0:n.decision)||"").toUpperCase()==="CONTINUE"}catch{return!1}}const B=p.useMemo(()=>{const e=Array.from(new Set(x.map(a=>a.jobRole).filter(Boolean)));return e.sort((a,r)=>String(a).localeCompare(String(r))),["ALL",...e]},[x]);async function v(e,a){if(h&&l("PRECALL_LIST",["HR","ADMIN"])){L(!0);try{const d=(await se(i,{date:e,jobRole:a&&a!=="ALL"?a:"",mode:"PREINTERVIEW"})).items??[];j(d.filter(m=>{if(!m.preCallAt)return!1;const S=String(m.onlineTestResult||"").toUpperCase();return!S}))}catch(r){s.error((r==null?void 0:r.message)||"Failed to load")}finally{L(!1)}}}p.useEffect(()=>{v(g,y)},[g,y,h]);const E=p.useMemo(()=>y==="ALL"?x:x.filter(e=>e.jobRole===y),[x,y]),k=p.useMemo(()=>E.filter(e=>String(e.preInterviewStatus||"").toUpperCase()!=="APPEARED"),[E]),w=p.useMemo(()=>E.filter(e=>String(e.preInterviewStatus||"").toUpperCase()==="APPEARED"),[E]);async function K(e){if(!l("PREINTERVIEW_STATUS",["HR","ADMIN"])){s.error("Not allowed");return}const a=`${e.candidateId}:APPEARED`;o(a);try{const r=await C(i,{requirementId:e.requirementId,candidateId:e.candidateId,op:"APPEARED"});s.success("Marked Appeared"),j(n=>n.map(d=>d.candidateId===e.candidateId?{...d,preInterviewStatus:r.preInterviewStatus||"APPEARED"}:d))}catch(r){s.error((r==null?void 0:r.message)||"Failed")}finally{o("")}}async function z(e){if(!l("PREINTERVIEW_STATUS",["HR","ADMIN"])){s.error("Not allowed");return}const a=ce("New pre-interview date/time",e.preCallAt);if(a==null)return;if(a==="INVALID"){s.error("Invalid date/time");return}if(a===""){s.error("Date/time required");return}const r=`${e.candidateId}:RESCHEDULE`;o(r);try{const n=await C(i,{requirementId:e.requirementId,candidateId:e.candidateId,op:"RESCHEDULE",preInterviewAt:a});s.success("Rescheduled"),j(d=>d.map(m=>m.candidateId===e.candidateId?{...m,preCallAt:n.preInterviewAt||a}:m))}catch(n){s.error((n==null?void 0:n.message)||"Failed")}finally{o("")}}async function J(e){if(!l("PREINTERVIEW_STATUS",["HR","ADMIN"])){s.error("Not allowed");return}const a=window.prompt("Reject remark (required):");if(a==null)return;if(!String(a).trim()){s.error("Remark required");return}const r=`${e.candidateId}:REJECT`;o(r);try{await C(i,{requirementId:e.requirementId,candidateId:e.candidateId,op:"REJECT",remark:String(a).trim()}),de({requirementId:e.requirementId,candidateId:e.candidateId}),s.success("Rejected"),j(n=>n.filter(d=>d.candidateId!==e.candidateId))}catch(n){s.error((n==null?void 0:n.message)||"Failed")}finally{o("")}}async function Y(e){if(!l("PREINTERVIEW_MARKS_SAVE",["HR","ADMIN"])){s.error("Not allowed");return}const a=M[e.candidateId];if(a==null||String(a).trim()===""){s.error("Enter marks");return}const r=`${e.candidateId}:MARKS`;o(r);try{const n=await ie(i,{requirementId:e.requirementId,candidateId:e.candidateId,marks:String(a).trim()});s.success("Marks saved"),j(d=>d.map(m=>m.candidateId===e.candidateId?{...m,preInterviewMarks:n.preInterviewMarks}:m))}catch(n){s.error((n==null?void 0:n.message)||"Failed")}finally{o("")}}async function G(e){if(!l("TEST_LINK_CREATE",["HR","ADMIN"])){s.error("Not allowed");return}const a=`${e.candidateId}:LINK`;o(a);try{const r=await le(i,{requirementId:e.requirementId,candidateId:e.candidateId}),n=`${window.location.origin}${window.location.pathname}#/test?token=${encodeURIComponent(r.token)}`;O(d=>({...d,[e.candidateId]:{url:n,token:r.token,expiresAt:r.expiresAt}})),s.success("Test link created")}catch(r){s.error((r==null?void 0:r.message)||"Failed")}finally{o("")}}async function X(e){if(!l("TEST_FAIL_DECIDE",["HR","ADMIN"])){s.error("Not allowed");return}const a=`${e.candidateId}:ONLINE_CONTINUE`;o(a);try{await _(i,{requirementId:e.requirementId,candidateId:e.candidateId,testType:"ONLINE_TEST",decision:"CONTINUE",remark:"",stageTag:"Online Test",meta:{marks:{score:e.onlineTestScore,result:e.onlineTestResult}}}),s.success("Continued by HR"),await v(g,y)}catch(r){s.error((r==null?void 0:r.message)||"Failed")}finally{o("")}}async function Z(e){if(!l("TEST_FAIL_DECIDE",["HR","ADMIN"])){s.error("Not allowed");return}const a=window.prompt("Remark (required):","");if(a==null)return;const r=String(a||"").trim();if(!r){s.error("Remark is required");return}const n=`${e.candidateId}:ONLINE_REJECT`;o(n);try{await _(i,{requirementId:e.requirementId,candidateId:e.candidateId,testType:"ONLINE_TEST",decision:"REJECT",remark:r,stageTag:"Online Test",meta:{marks:{score:e.onlineTestScore,result:e.onlineTestResult}}}),s.success("Rejected"),await v(g,y)}catch(d){s.error((d==null?void 0:d.message)||"Failed")}finally{o("")}}async function Q(e){var r;const a=(r=P[e.candidateId])==null?void 0:r.url;if(a)try{await navigator.clipboard.writeText(a),s.success("Copied")}catch{s.error("Copy failed")}}const ee=()=>v(g,y);return t.jsxs(re,{children:[h?null:t.jsxs("div",{className:"card",style:{padding:12,marginBottom:12},children:[t.jsx("div",{style:{fontWeight:700},children:"Not allowed"}),t.jsx("div",{className:"small",style:{color:"var(--gray-600)"},children:"You donâ€™t have access to Preinterview portal."})]}),t.jsxs("div",{style:{marginBottom:"20px"},children:[t.jsx("h1",{className:"page-title",children:"Pre-interview Scheduled"}),t.jsx("p",{className:"page-subtitle",children:"Manage scheduled pre-interviews and enter marks"})]}),t.jsxs("div",{className:"card",style:{marginBottom:"16px"},children:[t.jsxs("div",{className:"row",style:{gap:12,alignItems:"flex-end",flexWrap:"wrap"},children:[t.jsxs("div",{children:[t.jsx("div",{className:"small",style:{marginBottom:4},children:"Walk-in Date"}),t.jsx("input",{type:"date",value:g,onChange:e=>W(e.target.value)})]}),t.jsxs("button",{className:"button",onClick:ee,disabled:b,style:{display:"flex",alignItems:"center",gap:6},children:[b?t.jsx(N,{size:14}):null,"Refresh"]}),t.jsx("div",{style:{marginLeft:"auto"},children:t.jsxs("span",{className:"badge",children:[E.length," candidates"]})})]}),t.jsx("div",{style:{height:12}}),t.jsx("div",{className:"tabs",children:B.map(e=>t.jsx("button",{className:["tab",y===e?"active":""].join(" "),onClick:()=>q(e),type:"button",children:e},e))})]}),b?t.jsx(ne,{text:"Loading candidates..."}):t.jsxs(t.Fragment,{children:[t.jsx($,{title:"Scheduled Candidates",subtitle:"Candidates with pre-interview date/time fixed (from Precall 'Call Done')",badge:k.length,variant:"card",defaultOpen:!0,children:k.length===0?t.jsxs("div",{className:"empty-state",children:[t.jsx("div",{className:"empty-state-icon",children:"ðŸ“…"}),t.jsx("div",{className:"empty-state-text",children:"No scheduled candidates"})]}):t.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:10},children:k.map(e=>{const a=`${e.candidateId}:APPEARED`,r=`${e.candidateId}:RESCHEDULE`,n=`${e.candidateId}:REJECT`;return t.jsx("div",{className:"card",style:{background:"#fff",border:"1px solid var(--gray-200)"},children:t.jsxs("div",{className:"row",style:{alignItems:"center",flexWrap:"wrap",gap:12},children:[t.jsxs("div",{style:{flex:1,minWidth:200},children:[t.jsxs("div",{style:{fontWeight:700,fontSize:"15px"},children:[A(e)||e.candidateId,A(e)&&e.candidateId?t.jsxs("span",{className:"small",style:{fontWeight:400,marginLeft:8,color:"var(--gray-500)"},children:["(",e.candidateId,")"]}):null]}),t.jsxs("div",{className:"small",style:{color:"var(--gray-500)",marginTop:2},children:[e.jobTitle?`${e.jobTitle} Â· `:"",e.jobRole||"-"]}),t.jsxs("div",{style:{marginTop:6,display:"grid",gap:6},children:[t.jsxs("span",{className:"badge",style:{background:"var(--primary)",color:"#fff"},children:["ðŸ“… ",D(e.preCallAt)]}),t.jsx(F,{sla:e.sla})]})]}),t.jsxs("div",{className:"action-grid",children:[t.jsx(H,{cvFileId:e.cvFileId,token:i}),t.jsxs("button",{className:"button primary",type:"button",onClick:()=>K(e),disabled:!!u||!l("PREINTERVIEW_STATUS",["HR","ADMIN"]),children:[u===a?t.jsx(N,{size:14}):null,"Appeared"]}),t.jsxs("button",{className:"button",type:"button",onClick:()=>z(e),disabled:!!u||!l("PREINTERVIEW_STATUS",["HR","ADMIN"]),children:[u===r?t.jsx(N,{size:14}):null,"Reschedule"]}),t.jsxs("button",{className:"button danger",type:"button",onClick:()=>J(e),disabled:!!u||!l("PREINTERVIEW_STATUS",["HR","ADMIN"]),children:[u===n?t.jsx(N,{size:14}):null,"Reject"]})]})]})},e.candidateId)})})}),t.jsx("div",{style:{height:16}}),t.jsx($,{title:"Pre-interview Marks",subtitle:"Only candidates marked Appeared",badge:w.length,variant:"card",defaultOpen:!0,children:w.length===0?t.jsxs("div",{className:"empty-state",children:[t.jsx("div",{className:"empty-state-icon",children:"ðŸ“"}),t.jsx("div",{className:"empty-state-text",children:"No candidates ready for marks"})]}):t.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:10},children:w.map(e=>{const a=P[e.candidateId],r=`${e.candidateId}:MARKS`,n=`${e.candidateId}:LINK`,d=String(e.onlineTestResult||"").toUpperCase(),m=d==="FAIL"&&V(e,"ONLINE_TEST");return t.jsxs("div",{className:"card",style:{background:"#fff",border:"1px solid var(--gray-200)"},children:[t.jsxs("div",{className:"row",style:{alignItems:"center",gap:12,flexWrap:"wrap"},children:[t.jsxs("div",{style:{minWidth:240},children:[t.jsxs("div",{style:{fontWeight:700,fontSize:"15px"},children:[A(e)||e.candidateId,A(e)&&e.candidateId?t.jsxs("span",{className:"small",style:{fontWeight:400,marginLeft:8,color:"var(--gray-500)"},children:["(",e.candidateId,")"]}):null]}),t.jsxs("div",{className:"small",style:{color:"var(--gray-500)",marginTop:2},children:[e.jobTitle?`${e.jobTitle} Â· `:"",e.jobRole||"-"]}),t.jsxs("div",{style:{marginTop:6,display:"grid",gap:6},children:[t.jsxs("span",{className:"badge",style:{background:"var(--primary)",color:"#fff"},children:["ðŸ“… ",D(e.preCallAt)]}),t.jsx(F,{sla:e.sla})]})]}),t.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",flex:1},children:[t.jsx(H,{cvFileId:e.cvFileId,token:i}),t.jsx("input",{style:{width:100},placeholder:"Marks",value:M[e.candidateId]??e.preInterviewMarks??"",onChange:S=>U(te=>({...te,[e.candidateId]:S.target.value}))}),t.jsxs("button",{className:"button",type:"button",onClick:()=>Y(e),disabled:!!u||!l("PREINTERVIEW_MARKS_SAVE",["HR","ADMIN"]),children:[u===r?t.jsx(N,{size:14}):null,"Save"]}),t.jsxs("button",{className:"button primary",type:"button",onClick:()=>G(e),disabled:!!u||!l("TEST_LINK_CREATE",["HR","ADMIN"])||!!String(e.onlineTestSubmittedAt||"").trim(),children:[u===n?t.jsx(N,{size:14}):null,"Generate Link"]}),a!=null&&a.url?t.jsx("button",{className:"button",type:"button",onClick:()=>Q(e),children:"ðŸ“‹ Copy"}):null]})]}),a!=null&&a.url?t.jsxs("div",{style:{marginTop:12,padding:"10px 12px",background:"var(--gray-100)",borderRadius:"var(--radius)",fontSize:"13px",wordBreak:"break-all"},children:[t.jsx("strong",{children:"Test Link:"})," ",a.url,a.expiresAt?t.jsxs("span",{style:{color:"var(--gray-500)"},children:[" (expires: ",D(a.expiresAt),")"]}):""]}):null,d?t.jsxs("div",{style:{marginTop:12,display:"flex",gap:8,alignItems:"center",flexWrap:"wrap"},children:[t.jsxs("span",{className:"badge",style:{background:d==="PASS"?"#22c55e":"#ef4444",color:"#fff"},children:["Online Test: ",d,e.onlineTestScore!==""&&e.onlineTestScore!=null?` (${e.onlineTestScore}/10)`:""]}),d==="FAIL"?m?t.jsx("span",{className:"badge",style:{background:"#f59e0b",color:"#fff"},children:"Continued by HR"}):t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"badge",style:{background:"#ef4444",color:"#fff"},children:"Decision Required"}),t.jsx("button",{className:"button",type:"button",onClick:()=>X(e),disabled:!!u||!l("TEST_FAIL_DECIDE",["HR","ADMIN"]),children:"Continue"}),t.jsx("button",{className:"button danger",type:"button",onClick:()=>Z(e),disabled:!!u||!l("TEST_FAIL_DECIDE",["HR","ADMIN"]),children:"Reject"})]}):null]}):null]},e.candidateId)})})})]})]})}export{he as PreinterviewPage};
