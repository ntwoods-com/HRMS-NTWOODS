import{u as ne,a as de,r as l,t as oe,n,y as ce,j as e,z as ue,h as E,B as me,E as A,G as Q,H as J}from"./index-DOrSdxar.js";function $(o){const a=String(o||"").toUpperCase();return a==="DRAFT"?"DRAFT":a==="SUBMITTED"?"SUBMITTED":a==="CLARIFICATION"?"CLARIFICATION":a==="APPROVED"?"PROCESS":a==="CLOSED"?"CLOSED":a||"-"}function F(o,a){const b=String((o==null?void 0:o.jobRole)||(o==null?void 0:o.jobTitle)||"").trim()||"Requirement",q=String((a==null?void 0:a.fullName)||(a==null?void 0:a.email)||"").trim()||"System";return{raisedFor:b,concernedPerson:q}}function he(){const o=ne(),{token:a,me:b,role:q,legacyRole:z,permissions:L,canPortal:v,canAction:N}=de(),G=l.useCallback((s,t)=>{if(!s)return t;const i=v?v(s):null;return i===!0||i===!1?i:t},[v]),R=l.useCallback((s,t)=>{const i=N?N(s):null;return i===!0||i===!1?i:t},[N]),c=z||q,O=G("PORTAL_REQUIREMENTS",c==="EA"||c==="ADMIN"),S=R("REQUIREMENT_CREATE",c==="EA"||c==="ADMIN"),P=R("REQUIREMENT_UPDATE",c==="EA"||c==="ADMIN"),k=R("REQUIREMENT_SUBMIT",c==="EA"||c==="ADMIN"),D=R("REQUIREMENT_RESUBMIT",c==="EA"||c==="ADMIN");l.useMemo(()=>[{key:"OPEN",label:"Open"},{key:"CLARIFICATION",label:"Clarification"},{key:"CLOSED",label:"Closed"}],[]);const[j,T]=l.useState("OPEN"),[f,V]=l.useState([]),[X,M]=l.useState(!1),[w,U]=l.useState(!1),[I,Y]=l.useState([]),[W,Z]=l.useState({open:0,clarification:0,closed:0}),[C,B]=l.useState(""),[K,u]=l.useState(!1),[g,h]=l.useState(!1),m=l.useMemo(()=>({requirementId:null,templateId:"",jobRole:"",jobTitle:"",jd:"",responsibilities:"",skills:"",shift:"",payScale:"",perks:"",notes:"",requiredCount:1,latestRemark:"",status:"DRAFT"}),[]),[r,d]=l.useState(m),[x,y]=l.useState(""),_=l.useCallback(async()=>{M(!0);try{const s=await oe(a,{status:"ACTIVE",page:1,pageSize:500});V(s.items??[])}catch(s){n.error((s==null?void 0:s.message)??"Failed to load templates")}finally{M(!1)}},[a]),p=l.useCallback(async()=>{U(!0);try{const s=await ce(a,{tab:j});Y(s.items??[]),Z(s.counts??{open:0,clarification:0,closed:0})}catch(s){n.error((s==null?void 0:s.message)??"Failed to load requirements")}finally{U(!1)}},[a,j]);l.useEffect(()=>{_()},[_]),l.useEffect(()=>{p()},[p]);const ee=l.useCallback(s=>{const t=f.find(i=>i.templateId===s);d(i=>({...i,templateId:s,jobRole:(t==null?void 0:t.jobRole)??"",jobTitle:(t==null?void 0:t.jobTitle)??"",jd:(t==null?void 0:t.jd)??"",responsibilities:(t==null?void 0:t.responsibilities)??"",skills:(t==null?void 0:t.skills)??"",shift:(t==null?void 0:t.shift)??"",payScale:(t==null?void 0:t.payScale)??"",perks:(t==null?void 0:t.perks)??"",notes:(t==null?void 0:t.notes)??""}))},[f]),se=l.useMemo(()=>f.map(s=>e.jsxs("option",{value:s.templateId,children:[s.jobRole," — ",s.jobTitle]},s.templateId)),[f]),H=l.useCallback(async s=>{u(!0),y(""),B(s);try{const t=await ue(a,{requirementId:s});d({requirementId:t.requirementId,templateId:t.templateId,jobRole:t.jobRole??"",jobTitle:t.jobTitle??"",jd:t.jd??"",responsibilities:t.responsibilities??"",skills:t.skills??"",shift:t.shift??"",payScale:t.payScale??"",perks:t.perks??"",notes:t.notes??"",requiredCount:t.requiredCount??1,latestRemark:t.latestRemark??"",status:t.status??""})}catch(t){n.error((t==null?void 0:t.message)??"Failed to load requirement"),u(!1),d(m)}finally{B("")}},[a]),te=l.useMemo(()=>(I||[]).map(s=>e.jsxs("tr",{style:{borderTop:"1px solid #eee"},children:[e.jsx("td",{className:"small",children:s.requirementId}),e.jsx("td",{children:s.jobRole}),e.jsx("td",{children:s.raisedFor||"-"}),e.jsx("td",{children:s.requiredCount}),e.jsx("td",{children:s.joinedCount??0}),e.jsx("td",{children:e.jsx("span",{className:String(s.status).toUpperCase()==="CLARIFICATION"?"badge amber":"badge",children:$(s.status)})}),e.jsx("td",{className:"small",children:String(s.status).toUpperCase()==="CLARIFICATION"?e.jsx("span",{style:{fontWeight:600},children:s.latestRemark}):s.latestRemark||""}),e.jsx("td",{children:e.jsx("button",{className:"button",type:"button",disabled:g||w||!!C,onClick:()=>H(s.requirementId),children:"Edit"})})]},s.requirementId)),[I,g,w,C,H]);async function re(){const s=!r.requirementId;if(s&&!S){n.error("Not allowed");return}if(!s&&!P){n.error("Not allowed");return}h(!0);try{if(!r.templateId){n.error("Select a template");return}const t=F(r,b);if(r.requirementId)await A(a,{requirementId:r.requirementId,jobRole:r.jobRole,jobTitle:r.jobTitle,jd:r.jd,responsibilities:r.responsibilities,skills:r.skills,shift:r.shift,payScale:r.payScale,perks:r.perks,notes:r.notes,raisedFor:t.raisedFor,concernedPerson:t.concernedPerson,requiredCount:Number(r.requiredCount)}),n.success("Draft saved");else{const i=await me(a,{templateId:r.templateId,jobRole:r.jobRole,jobTitle:r.jobTitle,jd:r.jd,responsibilities:r.responsibilities,skills:r.skills,shift:r.shift,payScale:r.payScale,perks:r.perks,notes:r.notes,raisedFor:t.raisedFor,concernedPerson:t.concernedPerson,requiredCount:Number(r.requiredCount)});n.success("Draft created"),d(le=>({...le,requirementId:i.requirementId,status:"DRAFT"}))}await p()}catch(t){n.error((t==null?void 0:t.message)??"Failed to save")}finally{h(!1)}}async function ae(){if(!r.requirementId){n.error("Save draft first");return}if(!k){n.error("Not allowed");return}h(!0);try{await Q(a,{requirementId:r.requirementId}),n.success("Submitted to HR"),u(!1),d(m),await p()}catch(s){if(String((s==null?void 0:s.message)||"")==="Missing required fields"&&r.requirementId)try{const i=F(r,b);await A(a,{requirementId:r.requirementId,raisedFor:i.raisedFor,concernedPerson:i.concernedPerson,requiredCount:Number(r.requiredCount||1)}),await Q(a,{requirementId:r.requirementId}),n.success("Submitted to HR"),u(!1),d(m),await p();return}catch(i){n.error((i==null?void 0:i.message)??"Failed to submit");return}n.error((s==null?void 0:s.message)??"Failed to submit")}finally{h(!1)}}async function ie(){if(!r.requirementId){n.error("Select a requirement");return}if(!x.trim()){n.error("Remark is required for resubmit");return}if(!D){n.error("Not allowed");return}h(!0);try{await J(a,{requirementId:r.requirementId,remark:x.trim()}),n.success("Resubmitted to HR"),y(""),u(!1),d(m),await p()}catch(s){if(String((s==null?void 0:s.message)||"")==="Missing required fields"&&r.requirementId)try{const i=F(r,b);await A(a,{requirementId:r.requirementId,raisedFor:i.raisedFor,concernedPerson:i.concernedPerson,requiredCount:Number(r.requiredCount||1)}),await J(a,{requirementId:r.requirementId,remark:x.trim()}),n.success("Resubmitted"),u(!1),d(m),y(""),await p();return}catch(i){n.error((i==null?void 0:i.message)??"Failed to resubmit");return}n.error((s==null?void 0:s.message)??"Failed to resubmit")}finally{h(!1)}}return!O&&!L?e.jsx(E,{children:e.jsx("div",{className:"card",children:"This page is available for EA/Admin."})}):L&&!O?e.jsx(E,{children:e.jsx("div",{className:"card",children:"Not allowed."})}):e.jsxs(E,{children:[e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"row",children:[e.jsx("h2",{style:{margin:0},children:"Requirements"}),e.jsx("div",{className:"spacer"}),e.jsx("button",{className:"button",onClick:()=>o("/dashboard"),children:"Back"})]}),e.jsx("div",{style:{height:10}}),e.jsxs("div",{className:"tabs",children:[e.jsx("button",{className:["tab",j==="OPEN"?"active":""].join(" "),onClick:()=>T("OPEN"),type:"button",children:"Open"}),e.jsxs("button",{className:["tab",j==="CLARIFICATION"?"active":""].join(" "),onClick:()=>T("CLARIFICATION"),type:"button",children:["Clarification ",W.clarification?`(${W.clarification})`:""]}),e.jsx("button",{className:["tab",j==="CLOSED"?"active":""].join(" "),onClick:()=>T("CLOSED"),type:"button",children:"Closed"})]}),e.jsx("div",{style:{height:12}}),e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"small",children:w?"Loading…":`${I.length} items`}),e.jsx("div",{className:"spacer"}),e.jsx("button",{className:"button primary",type:"button",onClick:()=>{d(m),y(""),u(!0)},disabled:!S,children:"Raise Requirement"})]})]}),K?e.jsxs("div",{className:"card",style:{marginTop:12},children:[e.jsxs("div",{className:"row",children:[e.jsx("h3",{style:{margin:0},children:r.requirementId?`Edit ${r.requirementId}`:"Raise Requirement"}),e.jsx("div",{className:"spacer"}),e.jsx("button",{className:"button",type:"button",onClick:()=>{u(!1),d(m)},children:"Close"})]}),String(r.status).toUpperCase()==="CLARIFICATION"&&r.latestRemark?e.jsxs("div",{className:"card",style:{marginTop:12,background:"#fafafa",border:"1px solid #d0d5dd"},children:[e.jsx("div",{style:{fontWeight:600,marginBottom:6},children:"HR Clarification Remark"}),e.jsx("div",{className:"small",style:{whiteSpace:"pre-wrap"},children:r.latestRemark})]}):null,e.jsx("div",{style:{height:12}}),C?e.jsxs("div",{className:"small",children:["Loading ",C,"…"]}):null,e.jsxs("div",{className:"row",style:{flexWrap:"wrap"},children:[e.jsxs("label",{className:"small",style:{display:"grid",gap:6},children:["Template",e.jsxs("select",{value:r.templateId,onChange:s=>ee(s.target.value),disabled:X||!!r.requirementId,style:{padding:8,borderRadius:8,border:"1px solid #d0d5dd",minWidth:280},children:[e.jsx("option",{value:"",children:"Select…"}),se]}),r.requirementId?e.jsx("span",{className:"small",children:"Template locked after draft creation"}):null]}),e.jsxs("label",{className:"small",style:{display:"grid",gap:6},children:["Required Count",e.jsx("input",{type:"number",value:r.requiredCount,min:1,step:1,onChange:s=>d(t=>({...t,requiredCount:s.target.value})),style:{padding:8,borderRadius:8,border:"1px solid #d0d5dd",width:160}})]})]}),e.jsx("div",{style:{height:12}}),e.jsxs("div",{className:"row",style:{flexWrap:"wrap"},children:[e.jsxs("label",{className:"small",style:{display:"grid",gap:6},children:["Job Role",e.jsx("input",{value:r.jobRole,onChange:s=>d(t=>({...t,jobRole:s.target.value})),style:{padding:8,borderRadius:8,border:"1px solid #d0d5dd",minWidth:220}})]}),e.jsxs("label",{className:"small",style:{display:"grid",gap:6},children:["Job Title",e.jsx("input",{value:r.jobTitle,onChange:s=>d(t=>({...t,jobTitle:s.target.value})),style:{padding:8,borderRadius:8,border:"1px solid #d0d5dd",minWidth:260}})]}),e.jsxs("label",{className:"small",style:{display:"grid",gap:6},children:["Shift",e.jsx("input",{value:r.shift,onChange:s=>d(t=>({...t,shift:s.target.value})),style:{padding:8,borderRadius:8,border:"1px solid #d0d5dd",minWidth:180}})]}),e.jsxs("label",{className:"small",style:{display:"grid",gap:6},children:["Pay Scale",e.jsx("input",{value:r.payScale,onChange:s=>d(t=>({...t,payScale:s.target.value})),style:{padding:8,borderRadius:8,border:"1px solid #d0d5dd",minWidth:180}})]})]}),e.jsx("div",{style:{height:10}}),e.jsx("textarea",{placeholder:"JD",value:r.jd,onChange:s=>d(t=>({...t,jd:s.target.value})),rows:4,style:{width:"100%",padding:8,borderRadius:8,border:"1px solid #d0d5dd"}}),e.jsx("div",{style:{height:8}}),e.jsx("textarea",{placeholder:"Responsibilities",value:r.responsibilities,onChange:s=>d(t=>({...t,responsibilities:s.target.value})),rows:3,style:{width:"100%",padding:8,borderRadius:8,border:"1px solid #d0d5dd"}}),e.jsx("div",{style:{height:8}}),e.jsx("textarea",{placeholder:"Skills",value:r.skills,onChange:s=>d(t=>({...t,skills:s.target.value})),rows:3,style:{width:"100%",padding:8,borderRadius:8,border:"1px solid #d0d5dd"}}),e.jsx("div",{style:{height:8}}),e.jsx("textarea",{placeholder:"Perks",value:r.perks,onChange:s=>d(t=>({...t,perks:s.target.value})),rows:2,style:{width:"100%",padding:8,borderRadius:8,border:"1px solid #d0d5dd"}}),e.jsx("div",{style:{height:8}}),e.jsx("textarea",{placeholder:"Notes",value:r.notes,onChange:s=>d(t=>({...t,notes:s.target.value})),rows:2,style:{width:"100%",padding:8,borderRadius:8,border:"1px solid #d0d5dd"}}),e.jsx("div",{style:{height:12}}),e.jsxs("div",{className:"row",style:{flexWrap:"wrap"},children:[e.jsx("button",{className:"button",type:"button",onClick:re,disabled:g||(r.requirementId?!P:!S),children:"Save Draft"}),e.jsx("button",{className:"button primary",type:"button",onClick:ae,disabled:g||!r.requirementId||!k,title:r.requirementId?k?"":"Not allowed":"Save draft first",children:"Submit"}),String(r.status).toUpperCase()==="CLARIFICATION"?e.jsxs(e.Fragment,{children:[e.jsx("input",{placeholder:"Resubmit remark (required)",value:x,onChange:s=>y(s.target.value),style:{padding:8,borderRadius:8,border:"1px solid #d0d5dd",minWidth:260}}),e.jsx("button",{className:"button primary",type:"button",onClick:ie,disabled:g||!x.trim()||!D,children:"Resubmit"})]}):null,e.jsx("div",{className:"spacer"}),e.jsxs("div",{className:"small",children:["Status: ",$(r.status)]})]})]}):null,e.jsxs("div",{className:"card",style:{marginTop:12},children:[e.jsx("h3",{style:{marginTop:0},children:"List"}),e.jsx("div",{style:{overflowX:"auto"},children:e.jsxs("table",{width:"100%",cellPadding:"8",style:{borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{background:"#fafafa"},children:[e.jsx("th",{align:"left",children:"Requirement"}),e.jsx("th",{align:"left",children:"Role"}),e.jsx("th",{align:"left",children:"Raised For"}),e.jsx("th",{align:"left",children:"Required"}),e.jsx("th",{align:"left",children:"Joined"}),e.jsx("th",{align:"left",children:"Status"}),e.jsx("th",{align:"left",children:"HR Remark"}),e.jsx("th",{align:"left",children:"Action"})]})}),e.jsxs("tbody",{children:[te,I.length===0?e.jsx("tr",{children:e.jsx("td",{className:"small",colSpan:8,style:{padding:12},children:"No requirements"})}):null]})]})})]})]})}export{he as RequirementsPage};
