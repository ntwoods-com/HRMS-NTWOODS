import{a as X,r as u,j as t,h as Y,S as T,_ as Q,aB as Z,n as E,M as G,a4 as H,ac as $,aC as ee,af as te,aq as se,aD as ae}from"./index-3pZLK3h4.js";import{u as ne,d as le,a as re,t as p}from"./useNowTick-CWrjpJwC.js";const ie={HR_REVIEW:!0,JOB_POSTING:!0,ADD_CANDIDATE:!0,PRECALL:!0,PRE_INTERVIEW:!0,IN_PERSON:!0,TECHNICAL:!0,FINAL_INTERVIEW:!0,PROBATION:!0};function ce(){const{token:d,role:w,legacyRole:R,canPortal:_,canAction:O}=X();function z(s,l){const a=typeof _=="function"?_(s):null;if(a===!0||a===!1)return a;const o=String(R||w||"").toUpperCase();return Array.isArray(l)?l.includes(o):!1}function M(s,l){const a=typeof O=="function"?O(s):null;if(a===!0||a===!1)return a;const o=String(R||w||"").toUpperCase();return Array.isArray(l)?l.includes(o):!1}const h=z("PORTAL_ADMIN_SLA",["ADMIN"]),[N,D]=u.useState(!1),[S,V]=u.useState(!1),[b,j]=u.useState([]),[v,F]=u.useState(!1),[q,W]=u.useState({}),[k,B]=u.useState(""),U=ne({intervalMs:1e3,enabled:h});async function C(){if(h&&M("SLA_CONFIG_GET",["ADMIN"])){D(!0);try{const s=await Z(d);j(s.items??[])}catch(s){E.error((s==null?void 0:s.message)||"Failed to load SLA config"),j([])}finally{D(!1)}}}u.useEffect(()=>{C()},[h]);const I=u.useMemo(()=>{const s=Array.isArray(b)?[...b]:[];return s.sort((l,a)=>String(l.stepName||"").localeCompare(String(a.stepName||""))),s},[b]);async function L(){if(h){F(!0),B("");try{const s=[G(d,{tab:"REVIEW"}),G(d,{tab:"APPROVED"}),H(d,{date:"",jobRole:""}),H(d,{date:"",jobRole:"",mode:"PREINTERVIEW"}),$(d),ee(d),te(d),se(d)],[l,a,o,g,y,r,A,c]=await Promise.all(s),m={},i=(e,n)=>{n!=null&&(m[e]||(m[e]=[]),m[e].push(n))};((l==null?void 0:l.items)||[]).forEach(e=>i("HR_REVIEW",p(e.updatedAt||e.createdAt)));const f=(a==null?void 0:a.items)||[];f.filter(e=>String(e.jobPostingStatus||"").toUpperCase()!=="COMPLETE").forEach(e=>i("JOB_POSTING",p(e.updatedAt||e.createdAt))),f.filter(e=>String(e.jobPostingStatus||"").toUpperCase()==="COMPLETE"&&Number(e.candidateCount||0)===0).forEach(e=>{var n;return i("ADD_CANDIDATE",p(((n=e==null?void 0:e.jobPostingState)==null?void 0:n.completedAt)||e.updatedAt||e.createdAt))}),((o==null?void 0:o.items)||[]).filter(e=>!e.preCallAt&&!e.onlineTestResult&&!e.onlineTestSubmittedAt).forEach(e=>i("PRECALL",p(e.walkinAt))),((g==null?void 0:g.items)||[]).filter(e=>e.preCallAt&&String(e.preInterviewStatus||"").toUpperCase()!=="APPEARED"&&!e.onlineTestResult&&!e.onlineTestSubmittedAt).forEach(e=>i("PRE_INTERVIEW",p(e.preCallAt))),((y==null?void 0:y.items)||[]).filter(e=>!String(e.inPersonMarksAt||"").trim()).forEach(e=>i("IN_PERSON",p(e.onlineTestSubmittedAt))),((r==null?void 0:r.items)||[]).forEach(e=>i("TECHNICAL",p(e.techSelectedAt||e.updatedAt))),((A==null?void 0:A.items)||[]).forEach(e=>i("FINAL_INTERVIEW",p(e.techEvaluatedAt))),((c==null?void 0:c.items)||[]).filter(e=>String(e.status||"").toUpperCase()==="PROBATION").forEach(e=>i("PROBATION",p(e.probationStartAt))),W(m)}catch(s){W({}),B((s==null?void 0:s.message)||"Failed to load live SLA data")}finally{F(!1)}}}u.useEffect(()=>{h&&L()},[h]);async function J(){if(!M("SLA_CONFIG_UPSERT",["ADMIN"])){E.error("Not allowed");return}V(!0);try{await ae(d,I),E.success("Saved"),await C(),await L()}catch(s){E.error((s==null?void 0:s.message)||"Failed to save")}finally{V(!1)}}async function K(){await C(),await L()}return t.jsxs(Y,{children:[h?null:t.jsxs("div",{className:"card",style:{padding:12,marginBottom:12},children:[t.jsx("div",{style:{fontWeight:700},children:"Not allowed"}),t.jsx("div",{className:"small",style:{color:"var(--gray-600)"},children:"You don’t have access to SLA Config."})]}),t.jsxs("div",{style:{marginBottom:20},children:[t.jsx("h1",{className:"page-title",children:"SLA Config"}),t.jsx("p",{className:"page-subtitle",children:"Configure planned minutes per step (used to compute breach in StepMetrics)"})]}),t.jsxs("div",{className:"card",style:{marginBottom:16},children:[t.jsxs("div",{className:"row",style:{gap:12,alignItems:"center",flexWrap:"wrap"},children:[t.jsx("button",{className:"button",type:"button",onClick:K,disabled:N||S||v,children:N||v?t.jsxs(t.Fragment,{children:[t.jsx(T,{size:14})," Refreshing..."]}):"Refresh"}),t.jsx("button",{className:"button primary",type:"button",onClick:J,disabled:N||S,children:S?t.jsxs(t.Fragment,{children:[t.jsx(T,{size:14})," Saving..."]}):"Save"}),t.jsx("div",{style:{marginLeft:"auto"},children:t.jsxs("span",{className:"badge",children:[I.length," steps"]})})]}),k?t.jsx("div",{className:"small",style:{color:"#ef4444",marginTop:10},children:k}):null]}),N?t.jsx(Q,{text:"Loading..."}):t.jsx("div",{className:"card",style:{overflowX:"auto"},children:t.jsxs("table",{className:"table",style:{width:"100%",borderCollapse:"collapse"},children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{style:{textAlign:"left",padding:10},children:"Step"}),t.jsx("th",{style:{textAlign:"left",padding:10},children:"Planned Minutes"}),t.jsx("th",{style:{textAlign:"left",padding:10},children:"Enabled"}),t.jsx("th",{style:{textAlign:"left",padding:10},children:"Active"}),t.jsx("th",{style:{textAlign:"left",padding:10},children:"Oldest Timer"})]})}),t.jsx("tbody",{children:I.map((s,l)=>t.jsx("tr",{style:{borderTop:"1px solid var(--gray-200)"},children:(()=>{const a=String(s.stepName||"").toUpperCase(),o=!!ie[a],g=Number(s.plannedMinutes??0),y=!!s.enabled,r=o?q[a]||[]:null,A=Array.isArray(r)?r.length:null;let c=null;Array.isArray(r)&&r.length&&(c=r.reduce((e,n)=>typeof n=="number"&&n<e?n:e,r[0]));const m=g>0?g*60*1e3:0,i=y&&m>0&&Array.isArray(r)?r.filter(e=>typeof e=="number"&&U-e>m).length:0,f=y&&m>0&&c!=null?le({stepKey:a,stepStartAt:c,plannedMinutes:g,nowMs:U}):null;return t.jsxs(t.Fragment,{children:[t.jsx("td",{style:{padding:10,fontWeight:600},children:s.stepName}),t.jsx("td",{style:{padding:10},children:t.jsx("input",{type:"number",min:"0",value:s.plannedMinutes??0,onChange:e=>{const n=Number(e.target.value);j(x=>x.map(P=>P.stepName===s.stepName?{...P,plannedMinutes:Number.isFinite(n)?n:0}:P))},style:{width:140}})}),t.jsx("td",{style:{padding:10},children:t.jsxs("label",{style:{display:"flex",gap:6,alignItems:"center"},children:[t.jsx("input",{type:"checkbox",checked:!!s.enabled,onChange:e=>j(n=>n.map(x=>x.stepName===s.stepName?{...x,enabled:e.target.checked}:x))}),t.jsx("span",{className:"small",children:"Enabled"})]})}),t.jsx("td",{style:{padding:10},children:o?v?t.jsx(T,{size:14}):t.jsxs("div",{style:{display:"flex",gap:6,flexWrap:"wrap",alignItems:"center"},children:[t.jsxs("span",{className:"badge",children:[A||0," active"]}),i?t.jsxs("span",{className:"badge",style:{background:"#ef4444",color:"#fff"},children:[i," overdue"]}):null]}):t.jsx("span",{className:"small",style:{color:"var(--gray-500)"},children:"—"})}),t.jsx("td",{style:{padding:10},children:o?f==null?t.jsx("span",{className:"small",style:{color:"var(--gray-500)"},children:y?g>0?"No active":"Set planned minutes":"Disabled"}):t.jsxs("div",{style:{display:"grid",gap:4},children:[t.jsx("span",{className:"badge",style:{background:f.badgeVariant==="red"?"#ef4444":f.badgeVariant==="orange"?"#f59e0b":f.badgeVariant==="green"?"#22c55e":"var(--gray-400)",color:"#fff",fontFamily:"monospace"},children:f.badgeText}),c!=null?t.jsxs("span",{className:"small",style:{color:"var(--gray-500)"},children:["Oldest started: ",re(c)||"-"]}):null]}):t.jsx("span",{className:"small",style:{color:"var(--gray-500)"},children:"—"})})]})})()},s.stepName||l))})]})})]})}export{ce as SlaConfigPage};
