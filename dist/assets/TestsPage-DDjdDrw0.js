import{a as Y,r as c,b as X,n as d,j as s,A as Z,S,M as ee,ag as V,ah as se,ai as te,aj as B}from"./index-grL27em3.js";import{V as ae}from"./ViewCvButton-Cqus7HoZ.js";import{c as re}from"./pii-BcFV6mqh.js";import{S as ne}from"./SlaCountdown-DTF7N97H.js";import"./files-CjotXup9.js";import"./useNowTick-_9wyDYsU.js";function le(l){if(!l)return"";const f=l instanceof Date?l:new Date(l);return Number.isNaN(f.getTime())?String(l):f.toLocaleString()}function g(l){var x;const f=(l==null?void 0:l.candidateId)||"",v=((x=l==null?void 0:l.test)==null?void 0:x.testKey)||"";return`${f}:${v}`}function ge(){const{token:l,role:f,legacyRole:v,canPortal:x,canAction:C}=Y();function q(e,t){const a=typeof x=="function"?x(e):null;if(a===!0||a===!1)return a;const n=String(v||f||"").toUpperCase();return Array.isArray(t)?t.includes(n):!1}function p(e,t){const a=typeof C=="function"?C(e):null;if(a===!0||a===!1)return a;const n=String(v||f||"").toUpperCase();return Array.isArray(t)?t.includes(n):!1}const j=q("PORTAL_TESTS",["ADMIN","HR","EA","ACCOUNTS","MIS","DEO"]),w=p("CANDIDATE_TEST_ASSIGN",["ADMIN"]),L=p("USERS_LIST",["ADMIN"]),[y,E]=c.useState("FILL"),[T,D]=c.useState(!1),[b,F]=c.useState([]),[A,k]=c.useState([]),[u,m]=c.useState(""),[U,$]=c.useState({}),[I,M]=c.useState({}),[R,W]=c.useState([]),[_,O]=c.useState(!1);async function h(){if(j&&p("TESTS_QUEUE_LIST",["ADMIN","HR","EA","ACCOUNTS","MIS","DEO"])){D(!0);try{const[e,t]=await Promise.all([V(l,{mode:"FILL"}),V(l,{mode:"REVIEW"})]);F(e.items??[]),k(t.items??[])}catch(e){d.error((e==null?void 0:e.message)||"Failed to load")}finally{D(!1)}}}c.useEffect(()=>{h()},[j]),c.useEffect(()=>{j&&L&&(O(!0),X(l,{status:"ACTIVE",page:1,pageSize:500}).then(e=>W((e==null?void 0:e.items)??[])).catch(e=>{W([]),d.error((e==null?void 0:e.message)||"Failed to load users")}).finally(()=>O(!1)))},[j,L,l]);const K=c.useMemo(()=>y==="REVIEW"?A:b,[y,b,A]),z=c.useMemo(()=>{const e=new Map;return(R||[]).forEach(t=>{const a=String((t==null?void 0:t.role)||"").toUpperCase();a&&(e.has(a)||e.set(a,[]),e.get(a).push(t))}),e},[R]);function P(e){const t=Array.isArray(e==null?void 0:e.fillRoles)?e.fillRoles.map(r=>String(r||"").toUpperCase()).filter(Boolean):[];if(!t.length)return R||[];const a=[];t.forEach(r=>(z.get(r)||[]).forEach(o=>a.push(o)));const n=new Set;return a.filter(r=>{const o=String((r==null?void 0:r.userId)||"");return!o||n.has(o)?!1:(n.add(o),!0)})}async function H(e,t){var n;if(!w){d.error("Not allowed");return}const a=g(e);m(`ASSIGN:${a}`);try{await se(l,{candidateId:e.candidateId,testKey:(n=e.test)==null?void 0:n.testKey,fillOwnerUserId:String(t||"").trim()}),d.success("Assigned"),await h()}catch(r){d.error((r==null?void 0:r.message)||"Failed to assign")}finally{m("")}}async function G(e){var r;if(!p("CANDIDATE_TEST_SUBMIT",["ADMIN","EA","ACCOUNTS","MIS","DEO"])){d.error("Not allowed");return}const t=g(e),a=U[t],n=Number(a);if(!Number.isFinite(n)){d.error("Enter marks");return}m(t);try{await te(l,{requirementId:e.requirementId,candidateId:e.candidateId,testKey:(r=e.test)==null?void 0:r.testKey,marks:n,remarks:I[t]??""}),d.success("Submitted"),F(o=>o.filter(i=>g(i)!==t)),E("REVIEW"),await h()}catch(o){d.error((o==null?void 0:o.message)||"Failed")}finally{m("")}}async function Q(e){var a;if(!p("CANDIDATE_TEST_REVIEW",["ADMIN","HR"])){d.error("Not allowed");return}const t=g(e);m(t);try{await B(l,{requirementId:e.requirementId,candidateId:e.candidateId,testKey:(a=e.test)==null?void 0:a.testKey,decision:"APPROVE",remarks:I[t]??""}),d.success("Approved"),k(n=>n.filter(r=>g(r)!==t)),await h()}catch(n){d.error((n==null?void 0:n.message)||"Failed")}finally{m("")}}async function J(e){var n;if(!p("CANDIDATE_TEST_REVIEW",["ADMIN","HR"])){d.error("Not allowed");return}const t=g(e),a=String(I[t]??"").trim();if(!a){d.error("Remarks required");return}m(t);try{await B(l,{requirementId:e.requirementId,candidateId:e.candidateId,testKey:(n=e.test)==null?void 0:n.testKey,decision:"REJECT",remarks:a}),d.success("Rejected"),k(r=>r.filter(o=>g(o)!==t)),await h()}catch(r){d.error((r==null?void 0:r.message)||"Failed")}finally{m("")}}return s.jsxs(Z,{children:[j?null:s.jsxs("div",{className:"card",style:{padding:12,marginBottom:12},children:[s.jsx("div",{style:{fontWeight:700},children:"Not allowed"}),s.jsx("div",{className:"small",style:{color:"var(--gray-600)"},children:"You don’t have access to Tests."})]}),s.jsxs("div",{style:{marginBottom:20},children:[s.jsx("h1",{className:"page-title",children:"Tests"}),s.jsx("p",{className:"page-subtitle",children:"Fill marks and review required candidate tests (TestMaster driven)"})]}),s.jsxs("div",{className:"card",style:{marginBottom:16},children:[s.jsxs("div",{className:"row",style:{gap:12,alignItems:"flex-end",flexWrap:"wrap"},children:[s.jsx("button",{className:"button",type:"button",onClick:h,disabled:T,children:T?s.jsxs(s.Fragment,{children:[s.jsx(S,{size:14})," Refreshing..."]}):"Refresh"}),s.jsxs("div",{style:{marginLeft:"auto"},children:[s.jsxs("span",{className:"badge",children:["Fill: ",b.length]})," ",s.jsxs("span",{className:"badge",children:["Review: ",A.length]})]})]}),s.jsx("div",{style:{height:12}}),s.jsxs("div",{className:"tabs",children:[s.jsxs("button",{type:"button",className:["tab",y==="FILL"?"active":""].join(" "),onClick:()=>E("FILL"),children:["To Fill (",b.length,")"]}),s.jsxs("button",{type:"button",className:["tab",y==="REVIEW"?"active":""].join(" "),onClick:()=>E("REVIEW"),children:["To Review (",A.length,")"]})]})]}),T?s.jsx(ee,{text:"Loading..."}):K.length===0?s.jsxs("div",{className:"card",style:{textAlign:"center",padding:40},children:[s.jsx("div",{style:{fontSize:42,marginBottom:10},children:"✓"}),s.jsx("div",{className:"small",children:"Nothing pending"})]}):s.jsx("div",{style:{display:"grid",gridTemplateColumns:"1fr",gap:10},children:K.map(e=>{const t=g(e),a=e.test||{},n=u===`ASSIGN:${t}`,r=P(a),o=re(e);return s.jsx("div",{className:"card",style:{background:"#fff",border:"1px solid var(--gray-200)"},children:s.jsxs("div",{className:"row",style:{justifyContent:"space-between",gap:12,flexWrap:"wrap",alignItems:"center"},children:[s.jsxs("div",{style:{minWidth:240},children:[s.jsxs("div",{style:{fontWeight:700,fontSize:15},children:[o||e.candidateId,o&&e.candidateId?s.jsxs("span",{className:"small",style:{fontWeight:400,marginLeft:8,color:"var(--gray-500)"},children:["(",e.candidateId,")"]}):null]}),s.jsxs("div",{className:"small",style:{color:"var(--gray-500)",marginTop:2},children:[e.jobTitle?`${e.jobTitle} · `:"",e.jobRole||"-"]}),s.jsxs("div",{style:{marginTop:8,display:"flex",gap:8,flexWrap:"wrap"},children:[s.jsx("span",{className:"badge",children:a.label||a.testKey}),s.jsx("span",{className:"badge",children:String(a.status||"").toUpperCase()}),a.filledAt?s.jsxs("span",{className:"badge",children:["Filled: ",le(a.filledAt)]}):null,w&&y==="FILL"?s.jsx("span",{className:"badge",children:a.fillOwnerUserId?`Assigned: ${a.fillOwnerUserId}`:"Unassigned"}):null]}),s.jsx("div",{style:{marginTop:8},children:s.jsx(ne,{sla:e.sla})})]}),s.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap",alignItems:"center"},children:[s.jsx(ae,{cvFileId:e.cvFileId,token:l}),y==="FILL"?s.jsxs(s.Fragment,{children:[w?s.jsxs(s.Fragment,{children:[s.jsxs("select",{value:String(a.fillOwnerUserId||""),onChange:i=>H(e,i.target.value),disabled:!!u||_,style:{maxWidth:220},children:[s.jsx("option",{value:"",children:_?"Loading users...":"Unassigned"}),r.map(i=>s.jsxs("option",{value:i.userId,children:[i.fullName||i.userId," (",i.role,")",i.email?` • ${i.email}`:""]},i.userId))]}),n?s.jsx(S,{size:14}):null]}):null,s.jsx("input",{style:{width:100},placeholder:"Marks",value:U[t]??"",onChange:i=>$(N=>({...N,[t]:i.target.value}))}),s.jsx("input",{style:{width:180},placeholder:"Remarks (optional)",value:I[t]??"",onChange:i=>M(N=>({...N,[t]:i.target.value}))}),s.jsxs("button",{className:"button primary",type:"button",onClick:()=>G(e),disabled:!!u,children:[u===t?s.jsx(S,{size:14}):null,"Submit"]})]}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"small",style:{minWidth:140},children:["Marks: ",a.marksNumber!=null&&a.marksNumber!==""?`${a.marksNumber}`:String(a.marks??"")]}),s.jsx("input",{style:{width:220},placeholder:"Review remarks (required for reject)",value:I[t]??"",onChange:i=>M(N=>({...N,[t]:i.target.value}))}),s.jsxs("button",{className:"button",type:"button",onClick:()=>Q(e),disabled:!!u,children:[u===t?s.jsx(S,{size:14}):null,"Approve"]}),s.jsxs("button",{className:"button danger",type:"button",onClick:()=>J(e),disabled:!!u,children:[u===t?s.jsx(S,{size:14}):null,"Reject"]})]})]})]})},t)})})]})}export{ge as TestsPage};
